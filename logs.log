Attaching to hasura-saas_hs-subscription_1
[36mhs-subscription_1  |[0m go: downloading github.com/gorilla/mux v1.8.0
[36mhs-subscription_1  |[0m go: downloading github.com/stripe/stripe-go v70.15.0+incompatible
[36mhs-subscription_1  |[0m go: downloading github.com/sirupsen/logrus v1.8.1
[36mhs-subscription_1  |[0m go: downloading github.com/Yamashou/gqlgenc v0.0.2
[36mhs-subscription_1  |[0m go: downloading github.com/stretchr/testify v1.7.0
[36mhs-subscription_1  |[0m go: downloading github.com/google/uuid v1.3.0
[36mhs-subscription_1  |[0m go: downloading github.com/joomcode/errorx v1.0.3
[36mhs-subscription_1  |[0m go: downloading github.com/machinebox/graphql v0.2.2
[36mhs-subscription_1  |[0m go: downloading github.com/spf13/viper v1.8.1
[36mhs-subscription_1  |[0m go: downloading golang.org/x/sys v0.0.0-20210510120138-977fb7262007
[36mhs-subscription_1  |[0m go: downloading github.com/davecgh/go-spew v1.1.1
[36mhs-subscription_1  |[0m go: downloading github.com/pmezard/go-difflib v1.0.0
[36mhs-subscription_1  |[0m go: downloading github.com/stretchr/objx v0.1.0
[36mhs-subscription_1  |[0m go: downloading github.com/vektah/gqlparser/v2 v2.2.0
[36mhs-subscription_1  |[0m go: downloading github.com/pkg/errors v0.9.1
[36mhs-subscription_1  |[0m go: downloading github.com/fsnotify/fsnotify v1.4.9
[36mhs-subscription_1  |[0m go: downloading github.com/hashicorp/hcl v1.0.0
[36mhs-subscription_1  |[0m go: downloading github.com/magiconair/properties v1.8.5
[36mhs-subscription_1  |[0m go: downloading github.com/mitchellh/mapstructure v1.4.1
[36mhs-subscription_1  |[0m go: downloading github.com/spf13/afero v1.6.0
[36mhs-subscription_1  |[0m go: downloading github.com/pelletier/go-toml v1.9.3
[36mhs-subscription_1  |[0m go: downloading github.com/spf13/cast v1.3.1
[36mhs-subscription_1  |[0m go: downloading github.com/spf13/jwalterweatherman v1.1.0
[36mhs-subscription_1  |[0m go: downloading github.com/spf13/pflag v1.0.5
[36mhs-subscription_1  |[0m go: downloading github.com/subosito/gotenv v1.2.0
[36mhs-subscription_1  |[0m go: downloading gopkg.in/ini.v1 v1.62.0
[36mhs-subscription_1  |[0m go: downloading gopkg.in/yaml.v2 v2.4.0
[36mhs-subscription_1  |[0m go: downloading gopkg.in/yaml.v3 v3.0.0-20210107192922-496545a6307b
[36mhs-subscription_1  |[0m go: downloading golang.org/x/text v0.3.6
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:47Z" level=info msg="loading configuration"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:47Z" level=info msg="log level initialized" func=github.com/ddelizia/hasura-saas/pkg/logger.IntLogger file="/app/pkg/logger/index.go:15" log_level=debug
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:47Z" level=info msg="starting subscription server" func=main.main file="/app/cmd/subscription/main.go:19" serverPort=":1340"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_46ca51c0-959b-4516-bf5c-3d87f84c4abb\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=info msg="Request completed in 854.992457ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_46ca51c0-959b-4516-bf5c-3d87f84c4abb CUSTOMER_ID=cus_L1ZMkonh6wf3pO STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044850,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_46ca51c0-959b-4516-bf5c-3d87f84c4abb\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMkonh6wf3pO\",\"invoice_prefix\":\"ED90FFF9\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMkonh6wf3pO/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMkonh6wf3pO/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMkonh6wf3pO/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"08d0b64f-cdab-4895-9f09-f12f438e44d7\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:50Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=892223266
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"08d0b64f-cdab-4895-9f09-f12f438e44d7\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWDnFqtLrMpqCW9jGVVhbs\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=08d0b64f-cdab-4895-9f09-f12f438e44d7 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWDnFqtLrMpqCW9jGVVhbs/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=info msg="Request completed in 826.313359ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZMkonh6wf3pO STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044851,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMkonh6wf3pO\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWDnFqtLrMpqCW9jGVVhbs\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:52Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZMkonh6wf3pO\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=info msg="Request completed in 386.451674ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZMkonh6wf3pO STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044850,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_46ca51c0-959b-4516-bf5c-3d87f84c4abb\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMkonh6wf3pO\",\"invoice_prefix\":\"ED90FFF9\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDnFqtLrMpqCW9jGVVhbs\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMkonh6wf3pO/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMkonh6wf3pO/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMkonh6wf3pO/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=info msg="Request completed in 2.596574184s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZMkonh6wf3pO STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044853,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044853,\"current_period_end\":1645723253,\"current_period_start\":1643044853,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMkonh6wf3pO\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDpFqtLrMpqCWTB6570qa\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWDpFqtLrMpqCWTB6570qa\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044854,\"deleted\":false,\"id\":\"si_L1ZMBjoxNSGEPf\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWDpFqtLrMpqCWTB6570qa\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044853,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMkonh6wf3pO\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNYjFQbFpCU2FZM1d4NldweXVuZTZxWjFSUlZ601001n2x5D8e\",\"id\":\"in_1KLWDpFqtLrMpqCWDaYl5tqE\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNYjFQbFpCU2FZM1d4NldweXVuZTZxWjFSUlZ601001n2x5D8e/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWDpFqtLrMpqCWDaYl5tqE/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWDpFqtLrMpqCWZIPohNxW\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723253,\"start\":1643044853},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWDpFqtLrMpqCWTB6570qa\",\"subscription_item\":\"si_L1ZMBjoxNSGEPf\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"ED90FFF9-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWDqFqtLrMpqCW0DqKTlXa\",\"data\":[]},\"client_secret\":\"pi_3KLWDqFqtLrMpqCW0DqKTlXa_secret_1NJD0L48DQXGCBjxLwKDE3amI\",\"confirmation_method\":\"automatic\",\"created\":1643044854,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMkonh6wf3pO\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWDpFqtLrMpqCWDaYl5tqE\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWDqFqtLrMpqCW0DqKTlXa\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDnFqtLrMpqCW9jGVVhbs\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044853,\"period_start\":1643044853,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044853,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDpFqtLrMpqCWTB6570qa\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044853,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWDpFqtLrMpqCWTB6570qa
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"08d0b64f-cdab-4895-9f09-f12f438e44d7\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"08d0b64f-cdab-4895-9f09-f12f438e44d7\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3835377950
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_55273a54-b693-463d-9773-2348240ec4f8\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:55Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWDpFqtLrMpqCWTB6570qa
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWDpFqtLrMpqCWTB6570qa
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWDpFqtLrMpqCWTB6570qa\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=info msg="Request completed in 406.636402ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_55273a54-b693-463d-9773-2348240ec4f8 CUSTOMER_ID=cus_L1ZMmG5xvGYw5V STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044856,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_55273a54-b693-463d-9773-2348240ec4f8\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMmG5xvGYw5V\",\"invoice_prefix\":\"65095C60\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMmG5xvGYw5V/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMmG5xvGYw5V/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMmG5xvGYw5V/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"c764237f-2d2c-4aba-b8e5-3b1f4359c9e8\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=424968756
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=info msg="Request completed in 502.198108ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWDpFqtLrMpqCWTB6570qa
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"08d0b64f-cdab-4895-9f09-f12f438e44d7\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"c764237f-2d2c-4aba-b8e5-3b1f4359c9e8\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWDsFqtLrMpqCWlcFMbwUW\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=c764237f-2d2c-4aba-b8e5-3b1f4359c9e8 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWDsFqtLrMpqCWlcFMbwUW/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=info msg="Request completed in 732.258125ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZMmG5xvGYw5V STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044856,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMmG5xvGYw5V\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWDsFqtLrMpqCWlcFMbwUW\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZMmG5xvGYw5V\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=info msg="Request completed in 418.231938ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZMmG5xvGYw5V STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044856,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_55273a54-b693-463d-9773-2348240ec4f8\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMmG5xvGYw5V\",\"invoice_prefix\":\"65095C60\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDsFqtLrMpqCWlcFMbwUW\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMmG5xvGYw5V/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMmG5xvGYw5V/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMmG5xvGYw5V/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:20:58Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=info msg="Request completed in 2.444302989s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZMmG5xvGYw5V STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044858,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044858,\"current_period_end\":1645723258,\"current_period_start\":1643044858,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMmG5xvGYw5V\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDuFqtLrMpqCWXL0TUw4r\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWDuFqtLrMpqCWXL0TUw4r\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044858,\"deleted\":false,\"id\":\"si_L1ZM3edb5GBLdc\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWDuFqtLrMpqCWXL0TUw4r\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044858,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMmG5xvGYw5V\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNOXFLY0lKUUc4T0h0UTlvVnVxU0lOTHloQ3NI0100koTMng93\",\"id\":\"in_1KLWDuFqtLrMpqCWsLqefni5\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNOXFLY0lKUUc4T0h0UTlvVnVxU0lOTHloQ3NI0100koTMng93/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWDuFqtLrMpqCWsLqefni5/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWDuFqtLrMpqCWnoRWmnmz\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723258,\"start\":1643044858},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWDuFqtLrMpqCWXL0TUw4r\",\"subscription_item\":\"si_L1ZM3edb5GBLdc\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"65095C60-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWDvFqtLrMpqCW1qxPEBXx\",\"data\":[]},\"client_secret\":\"pi_3KLWDvFqtLrMpqCW1qxPEBXx_secret_ebEZRivdVqO4Klj4aSKgy5KW4\",\"confirmation_method\":\"automatic\",\"created\":1643044859,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMmG5xvGYw5V\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWDuFqtLrMpqCWsLqefni5\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWDvFqtLrMpqCW1qxPEBXx\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDsFqtLrMpqCWlcFMbwUW\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044858,\"period_start\":1643044858,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044858,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDuFqtLrMpqCWXL0TUw4r\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044858,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWDuFqtLrMpqCWXL0TUw4r
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"c764237f-2d2c-4aba-b8e5-3b1f4359c9e8\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"c764237f-2d2c-4aba-b8e5-3b1f4359c9e8\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3625979443
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_99356869-78fe-4299-935e-2725dc572741\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWDuFqtLrMpqCWXL0TUw4r
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWDuFqtLrMpqCWXL0TUw4r
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWDuFqtLrMpqCWXL0TUw4r\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=info msg="Request completed in 406.814621ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_99356869-78fe-4299-935e-2725dc572741 CUSTOMER_ID=cus_L1ZMPGatboKl3q STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044860,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_99356869-78fe-4299-935e-2725dc572741\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"5823E456\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"2f115876-63ee-4bfa-b42f-3644a522382f\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=431472497
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=info msg="Request completed in 284.815287ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWDuFqtLrMpqCWXL0TUw4r
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"c764237f-2d2c-4aba-b8e5-3b1f4359c9e8\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWDxFqtLrMpqCWpi6hZYEE\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=2f115876-63ee-4bfa-b42f-3644a522382f role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:01Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWDxFqtLrMpqCWpi6hZYEE/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:02Z" level=info msg="Request completed in 870.407072ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:02Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZMPGatboKl3q STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044861,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWDxFqtLrMpqCWpi6hZYEE\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:02Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZMPGatboKl3q\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:03Z" level=info msg="Request completed in 469.174646ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:03Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZMPGatboKl3q STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044860,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_99356869-78fe-4299-935e-2725dc572741\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"5823E456\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDxFqtLrMpqCWpi6hZYEE\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:03Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:04Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=info msg="Request completed in 2.283736142s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZMPGatboKl3q STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044863,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"current_period_end\":1645723263,\"current_period_start\":1643044863,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044863,\"deleted\":false,\"id\":\"si_L1ZM75uqNo5EL4\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWDzFqtLrMpqCW8BgOv8wf/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWDzFqtLrMpqCWmWx1nbyN\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723263,\"start\":1643044863},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"subscription_item\":\"si_L1ZM75uqNo5EL4\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"5823E456-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWDzFqtLrMpqCW00DJkvqm\",\"data\":[]},\"client_secret\":\"pi_3KLWDzFqtLrMpqCW00DJkvqm_secret_QuNlsWwqRa3402flpiWL53GHj\",\"confirmation_method\":\"automatic\",\"created\":1643044863,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWDzFqtLrMpqCW00DJkvqm\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDxFqtLrMpqCWpi6hZYEE\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044863,\"period_start\":1643044863,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044863,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044863,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWDzFqtLrMpqCWn7jgIoml
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3650710181
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWDzFqtLrMpqCWn7jgIoml
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWDzFqtLrMpqCWn7jgIoml
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWDzFqtLrMpqCWn7jgIoml\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=info msg="Request completed in 261.053658ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWDzFqtLrMpqCWn7jgIoml
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/retry
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="retry subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:42"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWE1FqtLrMpqCWcQ7zMDqK\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:50"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=2f115876-63ee-4bfa-b42f-3644a522382f role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:57"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZMPGatboKl3q\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=debug msg="executing paymentId change on the provider" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:64"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:05Z" level=info msg="Requesting GET api.stripe.com/v1/invoices\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=info msg="Request completed in 296.015027ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="retrieved invoice" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:119" CUSTOMER_ID=cus_L1ZMPGatboKl3q INVOICE_ID=in_1KLWDzFqtLrMpqCW8BgOv8wf STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWDzFqtLrMpqCW8BgOv8wf/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWDzFqtLrMpqCWmWx1nbyN\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723263,\"start\":1643044863},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"subscription_item\":\"si_L1ZM75uqNo5EL4\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"5823E456-0001\",\"paid\":false,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWDzFqtLrMpqCW00DJkvqm\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044863,\"period_start\":1643044863,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044863,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643044865,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWE1FqtLrMpqCWcQ7zMDqK/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:06Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=info msg="Request completed in 824.700886ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:136" CUSTOMER_ID=cus_L1ZMPGatboKl3q INVOICE_ID=in_1KLWDzFqtLrMpqCW8BgOv8wf STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044865,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWE1FqtLrMpqCWcQ7zMDqK\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZMPGatboKl3q\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=info msg="Request completed in 485.35128ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:155" CUSTOMER_ID=cus_L1ZMPGatboKl3q INVOICE_ID=in_1KLWDzFqtLrMpqCW8BgOv8wf STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044860,\"currency\":\"eur\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_99356869-78fe-4299-935e-2725dc572741\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"5823E456\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWE1FqtLrMpqCWcQ7zMDqK\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":2,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/subscriptions\",\"data\":[{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044863,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"current_period_end\":1645723263,\"current_period_start\":1643044863,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044863,\"deleted\":false,\"id\":\"si_L1ZM75uqNo5EL4\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044863,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMPGatboKl3q/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=info msg="Requesting GET api.stripe.com/v1/invoices/in_1KLWDzFqtLrMpqCW8BgOv8wf\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=info msg="Request completed in 344.06121ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=debug msg="invoice id updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:172" CUSTOMER_ID=cus_L1ZMPGatboKl3q INVOICE_ID=in_1KLWDzFqtLrMpqCW8BgOv8wf STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWDzFqtLrMpqCW8BgOv8wf/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWDzFqtLrMpqCWmWx1nbyN\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723263,\"start\":1643044863},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"subscription_item\":\"si_L1ZM75uqNo5EL4\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"5823E456-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWDzFqtLrMpqCW00DJkvqm\",\"data\":[]},\"client_secret\":\"pi_3KLWDzFqtLrMpqCW00DJkvqm_secret_QuNlsWwqRa3402flpiWL53GHj\",\"confirmation_method\":\"automatic\",\"created\":1643044863,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWDzFqtLrMpqCW00DJkvqm\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWDxFqtLrMpqCWpi6hZYEE\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044863,\"period_start\":1643044863,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044863,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643044865,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:07Z" level=info msg="Requesting POST api.stripe.com/v1/invoices/in_1KLWDzFqtLrMpqCW8BgOv8wf/pay\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:08Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:08Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:08Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:08Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=info msg="Request completed in 2.291190209s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="invoice paid" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:187" CUSTOMER_ID=cus_L1ZMPGatboKl3q INVOICE_ID=in_1KLWDzFqtLrMpqCW8BgOv8wf STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWDzFqtLrMpqCW0wAJ9P3x\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNNHN2c1V1TlJleE51bDNJN1FCSHFhN1MxSmpL0100erFNUZrl/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWDzFqtLrMpqCW8BgOv8wf/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWDzFqtLrMpqCWmWx1nbyN\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723263,\"start\":1643044863},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"subscription_item\":\"si_L1ZM75uqNo5EL4\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"5823E456-0001\",\"paid\":true,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWDzFqtLrMpqCW00DJkvqm\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044863,\"period_start\":1643044863,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643044863,\"marked_uncollectible_at\":0,\"paid_at\":1643044868,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643044865,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWDzFqtLrMpqCWn7jgIoml\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=info msg="Request completed in 327.571966ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="subscription found" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:200" CUSTOMER_ID=cus_L1ZMPGatboKl3q INVOICE_ID=in_1KLWDzFqtLrMpqCW8BgOv8wf STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044863,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044863,\"current_period_end\":1645723263,\"current_period_start\":1643044863,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMPGatboKl3q\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044863,\"deleted\":false,\"id\":\"si_L1ZM75uqNo5EL4\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWDzFqtLrMpqCWn7jgIoml\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWDzFqtLrMpqCW8BgOv8wf\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044863,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWDzFqtLrMpqCWn7jgIoml
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="update subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:74"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"2f115876-63ee-4bfa-b42f-3644a522382f\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=info msg="subscription retry done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:98" ACCOUNT_ID=2f115876-63ee-4bfa-b42f-3644a522382f CUSTOMER_ID=cus_L1ZMPGatboKl3q PLAN_ID=price_1IMKMvFqtLrMpqCW3mMM3mDS SUBSCRIPTION_ID=sub_1KLWDzFqtLrMpqCWn7jgIoml
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4606824314
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_1fc94c68-0b1b-4eef-b2ca-778ebb085ccb\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:10Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=info msg="Request completed in 447.968318ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_1fc94c68-0b1b-4eef-b2ca-778ebb085ccb CUSTOMER_ID=cus_L1ZMd51sWzICG1 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044870,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_1fc94c68-0b1b-4eef-b2ca-778ebb085ccb\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMd51sWzICG1\",\"invoice_prefix\":\"EF4DC0CF\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMd51sWzICG1/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMd51sWzICG1/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMd51sWzICG1/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=468471351
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWE7FqtLrMpqCWylJ0rkox\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=6d49a026-fe38-4ea4-88d9-e4fef8210139 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:11Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWE7FqtLrMpqCWylJ0rkox/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=info msg="Request completed in 922.083765ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZMd51sWzICG1 STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044871,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMd51sWzICG1\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWE7FqtLrMpqCWylJ0rkox\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZMd51sWzICG1\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:12Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=info msg="Request completed in 461.943385ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZMd51sWzICG1 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044870,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_1fc94c68-0b1b-4eef-b2ca-778ebb085ccb\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMd51sWzICG1\",\"invoice_prefix\":\"EF4DC0CF\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWE7FqtLrMpqCWylJ0rkox\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMd51sWzICG1/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMd51sWzICG1/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZMd51sWzICG1/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:13Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=info msg="Request completed in 2.257713938s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZMd51sWzICG1 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044873,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044873,\"current_period_end\":1645723273,\"current_period_start\":1643044873,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMd51sWzICG1\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWE9FqtLrMpqCW2mu6J6xV\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWE9FqtLrMpqCW2mu6J6xV\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044873,\"deleted\":false,\"id\":\"si_L1ZMMEII3Fo04d\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWE9FqtLrMpqCW2mu6J6xV\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044873,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMd51sWzICG1\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNSk5PV1ZqcHZHNjFBeHZlWTRtcVNTdE1BVFo00100b5YEfNel\",\"id\":\"in_1KLWE9FqtLrMpqCWI37icofd\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpNSk5PV1ZqcHZHNjFBeHZlWTRtcVNTdE1BVFo00100b5YEfNel/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWE9FqtLrMpqCWI37icofd/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWE9FqtLrMpqCW5KxmzKHH\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723273,\"start\":1643044873},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWE9FqtLrMpqCW2mu6J6xV\",\"subscription_item\":\"si_L1ZMMEII3Fo04d\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"EF4DC0CF-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWE9FqtLrMpqCW181LjP1H\",\"data\":[]},\"client_secret\":\"pi_3KLWE9FqtLrMpqCW181LjP1H_secret_8ttFoa8a0PxOr3PpIpR0rQHho\",\"confirmation_method\":\"automatic\",\"created\":1643044873,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZMd51sWzICG1\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWE9FqtLrMpqCWI37icofd\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWE9FqtLrMpqCW181LjP1H\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWE7FqtLrMpqCWylJ0rkox\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044873,\"period_start\":1643044873,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044873,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWE9FqtLrMpqCW2mu6J6xV\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044873,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWE9FqtLrMpqCW2mu6J6xV
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3672116420
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/change
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="change subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:52"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"id_plan\":\"premium\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="get stripe plan id" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func2" file="/app/pkg/subscription/handle_change.go:94"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:66"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=6d49a026-fe38-4ea4-88d9-e4fef8210139 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="GetStripePlanFromPlanID result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripePlanFromPlan file="/app/pkg/subscription/handle_utils.go:31" HASURA_RESPONSE="{\"subscription_plan\":[{\"stripe_code\":\"price_1IMKNbFqtLrMpqCWztWScMzg\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZMd51sWzICG1\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWE9FqtLrMpqCW2mu6J6xV\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="update subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:115"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="getting subscription information from stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:155"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWE9FqtLrMpqCW2mu6J6xV\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWE9FqtLrMpqCW2mu6J6xV
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWE9FqtLrMpqCW2mu6J6xV
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWE9FqtLrMpqCW2mu6J6xV\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=info msg="Request completed in 304.288136ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="updating subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:162"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions/sub_1KLWE9FqtLrMpqCW2mu6J6xV\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:15Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=info msg="Request completed in 488.491993ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWE9FqtLrMpqCW2mu6J6xV
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"6d49a026-fe38-4ea4-88d9-e4fef8210139\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=info msg="Request completed in 1.027635315s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=error msg="Request error from Stripe (status 400): {\"status\":400,\"message\":\"You cannot update a subscription in `incomplete` status in a way that results in a new invoice or invoice items. Only minor attributes, like `metadata` or `default_payment_method`, can be updated on such subscriptions.\",\"request_id\":\"req_A6fbXWEo0blxnD\",\"type\":\"invalid_request_error\"}" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=error msg="not able to update subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:174" SUBSCRIPTION_ID=sub_1KLWE9FqtLrMpqCW2mu6J6xV error="{\"status\":400,\"message\":\"You cannot update a subscription in `incomplete` status in a way that results in a new invoice or invoice items. Only minor attributes, like `metadata` or `default_payment_method`, can be updated on such subscriptions.\",\"request_id\":\"req_A6fbXWEo0blxnD\",\"type\":\"invalid_request_error\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1341430419
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_d798d26f-b423-4580-addd-9e6486c25303\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:16Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=info msg="Request completed in 379.468851ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_d798d26f-b423-4580-addd-9e6486c25303 CUSTOMER_ID=cus_L1ZM5beQbcIIbP STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044876,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_d798d26f-b423-4580-addd-9e6486c25303\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"61792D18\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZM5beQbcIIbP/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZM5beQbcIIbP/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZM5beQbcIIbP/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ade7090f-e255-444f-81dc-371da73a8e43\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=407164387
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ade7090f-e255-444f-81dc-371da73a8e43\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWEDFqtLrMpqCWcfiDl2Xd\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ade7090f-e255-444f-81dc-371da73a8e43 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:17Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWEDFqtLrMpqCWcfiDl2Xd/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=info msg="Request completed in 1.056806943s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZM5beQbcIIbP STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044877,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWEDFqtLrMpqCWcfiDl2Xd\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZM5beQbcIIbP\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:18Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=info msg="Request completed in 421.492496ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZM5beQbcIIbP STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044876,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_d798d26f-b423-4580-addd-9e6486c25303\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"61792D18\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWEDFqtLrMpqCWcfiDl2Xd\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZM5beQbcIIbP/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZM5beQbcIIbP/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZM5beQbcIIbP/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=info msg="Request completed in 2.056425873s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZM5beQbcIIbP STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044879,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044879,\"current_period_end\":1645723279,\"current_period_start\":1643044879,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044879,\"deleted\":false,\"id\":\"si_L1ZMzGS7zvfZg4\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044879,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpOVWsxbVZTVW9LbXZNT0lteVZuTTJBczMwVkk101008qOXPFeU\",\"id\":\"in_1KLWEFFqtLrMpqCWtq9nrsQV\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpOVWsxbVZTVW9LbXZNT0lteVZuTTJBczMwVkk101008qOXPFeU/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWEFFqtLrMpqCWtq9nrsQV/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWEFFqtLrMpqCWsfUnYJ9m\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723279,\"start\":1643044879},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"subscription_item\":\"si_L1ZMzGS7zvfZg4\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"61792D18-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWEGFqtLrMpqCW1okbGohJ\",\"data\":[]},\"client_secret\":\"pi_3KLWEGFqtLrMpqCW1okbGohJ_secret_FjuuHsjuHbcKXAW0RbdbOqbxa\",\"confirmation_method\":\"automatic\",\"created\":1643044880,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWEFFqtLrMpqCWtq9nrsQV\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWEGFqtLrMpqCW1okbGohJ\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWEDFqtLrMpqCWcfiDl2Xd\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044879,\"period_start\":1643044879,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044879,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044879,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWEFFqtLrMpqCWp3ozrVbi
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"ade7090f-e255-444f-81dc-371da73a8e43\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ade7090f-e255-444f-81dc-371da73a8e43\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3567683186
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/cancel
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="cancel subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:36"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ade7090f-e255-444f-81dc-371da73a8e43\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:44"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ade7090f-e255-444f-81dc-371da73a8e43 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="retrieving subscription id on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:51"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="GetStripeSubscription result" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).getStripeSubscriptionID" file="/app/pkg/subscription/handle_cancel.go:99" HASURA_RESPONSE="{\"subscription_status\":[{\"stripe_subscription_id\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="cancelling stripe subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:58"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=info msg="Requesting DELETE api.stripe.com/v1/subscriptions/sub_1KLWEFFqtLrMpqCWp3ozrVbi\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWEFFqtLrMpqCWp3ozrVbi
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWEFFqtLrMpqCWp3ozrVbi
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWEFFqtLrMpqCWp3ozrVbi\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=info msg="Request completed in 283.598418ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWEFFqtLrMpqCWp3ozrVbi
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"ade7090f-e255-444f-81dc-371da73a8e43\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:21Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=info msg="Request completed in 1.675026703s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).cancelStripeSubscription" file="/app/pkg/subscription/handle_cancel.go:120" ACCOUNT_ID=ade7090f-e255-444f-81dc-371da73a8e43 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044879,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":1643044882,\"collection_method\":\"charge_automatically\",\"created\":1643044879,\"current_period_end\":1645723279,\"current_period_start\":1643044879,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZM5beQbcIIbP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":1643044882,\"id\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044879,\"deleted\":false,\"id\":\"si_L1ZMzGS7zvfZg4\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWEFFqtLrMpqCWp3ozrVbi\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWEFFqtLrMpqCWtq9nrsQV\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044879,\"status\":\"incomplete_expired\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWEFFqtLrMpqCWp3ozrVbi
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="updating hasura with the cancellation status" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:65"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"ade7090f-e255-444f-81dc-371da73a8e43\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete_expired\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:72"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"status\":\"incomplete_expired\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1690933590
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_bbd1cc89-9d86-4bbd-ad84-0ff353ccf74b\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:22Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=info msg="Request completed in 375.118335ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_bbd1cc89-9d86-4bbd-ad84-0ff353ccf74b CUSTOMER_ID=cus_L1ZNQ71abpEqXP STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044883,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_bbd1cc89-9d86-4bbd-ad84-0ff353ccf74b\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNQ71abpEqXP\",\"invoice_prefix\":\"9973B385\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNQ71abpEqXP/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNQ71abpEqXP/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNQ71abpEqXP/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7cda72da-c4b0-409c-b63e-d0fd51f5fd0a\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=399465159
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7cda72da-c4b0-409c-b63e-d0fd51f5fd0a\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWEJFqtLrMpqCWhHa7xXaE\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7cda72da-c4b0-409c-b63e-d0fd51f5fd0a role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:23Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWEJFqtLrMpqCWhHa7xXaE/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:24Z" level=info msg="Request completed in 729.961407ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:24Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZNQ71abpEqXP STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643044883,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNQ71abpEqXP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWEJFqtLrMpqCWhHa7xXaE\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:24Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZNQ71abpEqXP\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:25Z" level=info msg="Request completed in 910.759452ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:25Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZNQ71abpEqXP STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044883,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_bbd1cc89-9d86-4bbd-ad84-0ff353ccf74b\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNQ71abpEqXP\",\"invoice_prefix\":\"9973B385\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWEJFqtLrMpqCWhHa7xXaE\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNQ71abpEqXP/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNQ71abpEqXP/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNQ71abpEqXP/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:25Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.canceled
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=payment_intent.canceled
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.voided
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.voided
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:26Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=info msg="Request completed in 1.99928087s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZNQ71abpEqXP STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643044885,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643044885,\"current_period_end\":1645723285,\"current_period_start\":1643044885,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNQ71abpEqXP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWELFqtLrMpqCWVFl2tvsI\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWELFqtLrMpqCWVFl2tvsI\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643044886,\"deleted\":false,\"id\":\"si_L1ZNk3kL3GgbFB\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWELFqtLrMpqCWVFl2tvsI\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643044885,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNQ71abpEqXP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpOREowRUVlZGFnUDVzZVh5ZEs3eEhJRWt3QlVS0100qqwTT3wx\",\"id\":\"in_1KLWELFqtLrMpqCWbA4oAKhF\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpOREowRUVlZGFnUDVzZVh5ZEs3eEhJRWt3QlVS0100qqwTT3wx/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWELFqtLrMpqCWbA4oAKhF/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWELFqtLrMpqCWIF5t53lj\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723285,\"start\":1643044885},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWELFqtLrMpqCWVFl2tvsI\",\"subscription_item\":\"si_L1ZNk3kL3GgbFB\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"9973B385-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWEMFqtLrMpqCW1Kuc29qA\",\"data\":[]},\"client_secret\":\"pi_3KLWEMFqtLrMpqCW1Kuc29qA_secret_DCy28z31KpiqP12Pw1jyqKOHz\",\"confirmation_method\":\"automatic\",\"created\":1643044886,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNQ71abpEqXP\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWELFqtLrMpqCWbA4oAKhF\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWEMFqtLrMpqCW1Kuc29qA\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWEJFqtLrMpqCWhHa7xXaE\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643044885,\"period_start\":1643044885,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643044885,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWELFqtLrMpqCWVFl2tvsI\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643044885,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWELFqtLrMpqCWVFl2tvsI
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7cda72da-c4b0-409c-b63e-d0fd51f5fd0a\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7cda72da-c4b0-409c-b63e-d0fd51f5fd0a\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3670338155
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_892d0c53-71a5-4f68-911b-3fa78f1eb3b0\",\"id_plan\":\"free\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWELFqtLrMpqCWVFl2tvsI
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWELFqtLrMpqCWVFl2tvsI
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWELFqtLrMpqCWVFl2tvsI\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=info msg="Request completed in 390.806593ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_892d0c53-71a5-4f68-911b-3fa78f1eb3b0 CUSTOMER_ID=cus_L1ZN66zMCwFbin STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044887,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_892d0c53-71a5-4f68-911b-3fa78f1eb3b0\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZN66zMCwFbin\",\"invoice_prefix\":\"53DF9087\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZN66zMCwFbin/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZN66zMCwFbin/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZN66zMCwFbin/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7e004b14-2da2-4b5d-866d-2cbee97e6b04\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=410565304
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50576" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7e004b14-2da2-4b5d-866d-2cbee97e6b04\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7e004b14-2da2-4b5d-866d-2cbee97e6b04 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:21:28 http: panic serving 172.26.0.3:50576: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 7 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc000198b40)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e1c0, 0xc000262a00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e1c0, 0xc000262a00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e1c0, 0xc000262900)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e1c0, 0xc000262800)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e1c0, 0xc000262700)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e1c0, 0xc000262700)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e1c0, 0xc000262500)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e1c0, 0xc000262500)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e1c0, 0xc000262500)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc000198b40, 0x908440, 0xc000096000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50856" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7e004b14-2da2-4b5d-866d-2cbee97e6b04\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7e004b14-2da2-4b5d-866d-2cbee97e6b04 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:21:28 http: panic serving 172.26.0.3:50856: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 171 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00045c6e0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0001587e0, 0xc000476500)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0001587e0, 0xc000476500)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0001587e0, 0xc000476400)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0001587e0, 0xc000476300)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0001587e0, 0xc000476200)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0001587e0, 0xc000476200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0001587e0, 0xc0000bea00)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0001587e0, 0xc0000bea00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0001587e0, 0xc0000bea00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00045c6e0, 0x908440, 0xc0003f4580)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50858" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_d814c6eb-c819-4d01-9a74-dabeb65f2c0a\",\"id_plan\":\"basic_trial\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=info msg="Request completed in 277.548623ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWELFqtLrMpqCWVFl2tvsI
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7cda72da-c4b0-409c-b63e-d0fd51f5fd0a\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=info msg="Request completed in 494.609885ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_d814c6eb-c819-4d01-9a74-dabeb65f2c0a CUSTOMER_ID=cus_L1ZNCEVoDHCU00 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643044888,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_d814c6eb-c819-4d01-9a74-dabeb65f2c0a\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZNCEVoDHCU00\",\"invoice_prefix\":\"55A78222\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNCEVoDHCU00/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNCEVoDHCU00/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZNCEVoDHCU00/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"4608a6cf-158a-4f12-9017-5827d2765537\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=516195492
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50858" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"4608a6cf-158a-4f12-9017-5827d2765537\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=4608a6cf-158a-4f12-9017-5827d2765537 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:21:28 http: panic serving 172.26.0.3:50858: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 172 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00045c780)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e2a0, 0xc00014b200)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b200)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b100)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b000)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014af00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e2a0, 0xc00014af00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e2a0, 0xc00014ab00)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e2a0, 0xc00014ab00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e2a0, 0xc00014ab00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00045c780, 0x908440, 0xc0003f4600)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:50864" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"4608a6cf-158a-4f12-9017-5827d2765537\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=4608a6cf-158a-4f12-9017-5827d2765537 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:21:28 http: panic serving 172.26.0.3:50864: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 185 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc000270500)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc000158460, 0xc0000bec00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc000158460, 0xc0000bec00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc000158460, 0xc0000bea00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc000158460, 0xc0000be900)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc000158460, 0xc0000be800)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc000158460, 0xc0000be800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc000158460, 0xc00014b400)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc000158460, 0xc00014b400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc000158460, 0xc00014b400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc000270500, 0x908440, 0xc0003f4ac0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:21:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_29ff0f22-ce60-4358-a25f-c62cde981e6a\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:02Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=info msg="Request completed in 10.930217551s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_29ff0f22-ce60-4358-a25f-c62cde981e6a CUSTOMER_ID=cus_L1ZRQMxLD8Ukit STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045173,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_29ff0f22-ce60-4358-a25f-c62cde981e6a\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRQMxLD8Ukit\",\"invoice_prefix\":\"7DF8862F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRQMxLD8Ukit/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRQMxLD8Ukit/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRQMxLD8Ukit/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"e936ac18-6d7b-4847-bf71-1696a6bc1fc9\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:13Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=10956685915
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:14Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:14Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:14Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:14Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"e936ac18-6d7b-4847-bf71-1696a6bc1fc9\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJ0FqtLrMpqCWD1w0LT3x\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=e936ac18-6d7b-4847-bf71-1696a6bc1fc9 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:15Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJ0FqtLrMpqCWD1w0LT3x/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=info msg="Request completed in 847.235738ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZRQMxLD8Ukit STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045175,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRQMxLD8Ukit\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJ0FqtLrMpqCWD1w0LT3x\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZRQMxLD8Ukit\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=info msg="Request completed in 399.819598ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZRQMxLD8Ukit STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045173,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_29ff0f22-ce60-4358-a25f-c62cde981e6a\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRQMxLD8Ukit\",\"invoice_prefix\":\"7DF8862F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ0FqtLrMpqCWD1w0LT3x\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRQMxLD8Ukit/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRQMxLD8Ukit/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRQMxLD8Ukit/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=info msg="Request completed in 2.233632746s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZRQMxLD8Ukit STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045176,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045176,\"current_period_end\":1645723576,\"current_period_start\":1643045176,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRQMxLD8Ukit\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJ2FqtLrMpqCWYtLb8VI5\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJ2FqtLrMpqCWYtLb8VI5\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045177,\"deleted\":false,\"id\":\"si_L1ZRGzzmnwfSF2\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJ2FqtLrMpqCWYtLb8VI5\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045176,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRQMxLD8Ukit\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpSUVJPTDVoOFhvYVRFaFNENUR2b2h2dlRITmlS01007XhhcICn\",\"id\":\"in_1KLWJ2FqtLrMpqCW4hW7VQ2P\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpSUVJPTDVoOFhvYVRFaFNENUR2b2h2dlRITmlS01007XhhcICn/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJ2FqtLrMpqCW4hW7VQ2P/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJ2FqtLrMpqCWlxX5JkIq\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723576,\"start\":1643045176},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJ2FqtLrMpqCWYtLb8VI5\",\"subscription_item\":\"si_L1ZRGzzmnwfSF2\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"7DF8862F-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJ3FqtLrMpqCW0mvpKGlh\",\"data\":[]},\"client_secret\":\"pi_3KLWJ3FqtLrMpqCW0mvpKGlh_secret_a39msbKeBfEVy17SgfHsrEoCf\",\"confirmation_method\":\"automatic\",\"created\":1643045177,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRQMxLD8Ukit\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJ2FqtLrMpqCW4hW7VQ2P\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJ3FqtLrMpqCW0mvpKGlh\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ0FqtLrMpqCWD1w0LT3x\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045176,\"period_start\":1643045176,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045176,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJ2FqtLrMpqCWYtLb8VI5\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045176,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJ2FqtLrMpqCWYtLb8VI5
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"e936ac18-6d7b-4847-bf71-1696a6bc1fc9\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"e936ac18-6d7b-4847-bf71-1696a6bc1fc9\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3509652084
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_af49b6ad-d430-469f-80d8-dbf6be35eb70\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWJ2FqtLrMpqCWYtLb8VI5
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWJ2FqtLrMpqCWYtLb8VI5
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:18Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJ2FqtLrMpqCWYtLb8VI5\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=info msg="Request completed in 426.654797ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_af49b6ad-d430-469f-80d8-dbf6be35eb70 CUSTOMER_ID=cus_L1ZRfA3Zh3J62T STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045178,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_af49b6ad-d430-469f-80d8-dbf6be35eb70\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRfA3Zh3J62T\",\"invoice_prefix\":\"7CB31031\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRfA3Zh3J62T/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRfA3Zh3J62T/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRfA3Zh3J62T/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"67b2054c-0612-4194-bfa8-fefc5105c5a1\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=450685077
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=info msg="Request completed in 515.38152ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWJ2FqtLrMpqCWYtLb8VI5
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"e936ac18-6d7b-4847-bf71-1696a6bc1fc9\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"67b2054c-0612-4194-bfa8-fefc5105c5a1\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJ5FqtLrMpqCWNCzVcFDS\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=67b2054c-0612-4194-bfa8-fefc5105c5a1 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJ5FqtLrMpqCWNCzVcFDS/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=info msg="Request completed in 796.330746ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZRfA3Zh3J62T STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045179,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRfA3Zh3J62T\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJ5FqtLrMpqCWNCzVcFDS\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZRfA3Zh3J62T\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:20Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=info msg="Request completed in 449.504993ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZRfA3Zh3J62T STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045178,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_af49b6ad-d430-469f-80d8-dbf6be35eb70\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRfA3Zh3J62T\",\"invoice_prefix\":\"7CB31031\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ5FqtLrMpqCWNCzVcFDS\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRfA3Zh3J62T/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRfA3Zh3J62T/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZRfA3Zh3J62T/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:21Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=info msg="Request completed in 2.143990411s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZRfA3Zh3J62T STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045181,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045181,\"current_period_end\":1645723581,\"current_period_start\":1643045181,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRfA3Zh3J62T\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJ7FqtLrMpqCWCOTXzxln\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJ7FqtLrMpqCWCOTXzxln\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045181,\"deleted\":false,\"id\":\"si_L1ZSedSC9wATki\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJ7FqtLrMpqCWCOTXzxln\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045181,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRfA3Zh3J62T\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTMzVqcmFXa1hkVHVqTThXMjJqN1VOWkxSRVhJ0100KCMg99Yc\",\"id\":\"in_1KLWJ7FqtLrMpqCW4PYsVD6K\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTMzVqcmFXa1hkVHVqTThXMjJqN1VOWkxSRVhJ0100KCMg99Yc/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJ7FqtLrMpqCW4PYsVD6K/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJ7FqtLrMpqCWCwXC3pAR\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723581,\"start\":1643045181},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJ7FqtLrMpqCWCOTXzxln\",\"subscription_item\":\"si_L1ZSedSC9wATki\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"7CB31031-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJ7FqtLrMpqCW0PYue5sC\",\"data\":[]},\"client_secret\":\"pi_3KLWJ7FqtLrMpqCW0PYue5sC_secret_h42i6OtK1d5wQn8Gb0toCx3Ut\",\"confirmation_method\":\"automatic\",\"created\":1643045181,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZRfA3Zh3J62T\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJ7FqtLrMpqCW4PYsVD6K\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJ7FqtLrMpqCW0PYue5sC\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ5FqtLrMpqCWNCzVcFDS\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045181,\"period_start\":1643045181,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045181,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJ7FqtLrMpqCWCOTXzxln\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045181,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJ7FqtLrMpqCWCOTXzxln
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"67b2054c-0612-4194-bfa8-fefc5105c5a1\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"67b2054c-0612-4194-bfa8-fefc5105c5a1\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3420454950
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_7b65885f-a359-4f76-ab21-d0fb3c8f3ccd\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWJ7FqtLrMpqCWCOTXzxln
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWJ7FqtLrMpqCWCOTXzxln
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJ7FqtLrMpqCWCOTXzxln\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=info msg="Request completed in 425.110915ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_7b65885f-a359-4f76-ab21-d0fb3c8f3ccd CUSTOMER_ID=cus_L1ZS0RelNXw9Wm STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045183,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_7b65885f-a359-4f76-ab21-d0fb3c8f3ccd\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"BD39B730\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"c87ef685-27de-4864-bf69-1c9a9272973f\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=437925968
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=info msg="Request completed in 473.792983ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWJ7FqtLrMpqCWCOTXzxln
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"67b2054c-0612-4194-bfa8-fefc5105c5a1\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJ9FqtLrMpqCWow0vT4Hj\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=c87ef685-27de-4864-bf69-1c9a9272973f role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJ9FqtLrMpqCWow0vT4Hj/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=info msg="Request completed in 682.264701ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045184,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJ9FqtLrMpqCWow0vT4Hj\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:24Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZS0RelNXw9Wm\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=info msg="Request completed in 422.652479ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045183,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_7b65885f-a359-4f76-ab21-d0fb3c8f3ccd\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"BD39B730\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ9FqtLrMpqCWow0vT4Hj\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=info msg="Request completed in 2.233719206s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045185,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"current_period_end\":1645723585,\"current_period_start\":1643045185,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045186,\"deleted\":false,\"id\":\"si_L1ZScRkZ3bFt6O\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJBFqtLrMpqCWZDMgN9Fl/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJBFqtLrMpqCWoMXyb2VW\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723585,\"start\":1643045185},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"subscription_item\":\"si_L1ZScRkZ3bFt6O\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"BD39B730-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJCFqtLrMpqCW0cJaBSm2\",\"data\":[]},\"client_secret\":\"pi_3KLWJCFqtLrMpqCW0cJaBSm2_secret_9Cl3ZKwQKPKwSEw3fCBybGNEl\",\"confirmation_method\":\"automatic\",\"created\":1643045186,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJCFqtLrMpqCW0cJaBSm2\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ9FqtLrMpqCWow0vT4Hj\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045185,\"period_start\":1643045185,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045185,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045185,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJBFqtLrMpqCWSnaaNCkB
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3369530178
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWJBFqtLrMpqCWSnaaNCkB
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWJBFqtLrMpqCWSnaaNCkB
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJBFqtLrMpqCWSnaaNCkB\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=info msg="Request completed in 270.559951ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWJBFqtLrMpqCWSnaaNCkB
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/retry
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="retry subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:42"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJDFqtLrMpqCWW6PWlicG\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:50"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=c87ef685-27de-4864-bf69-1c9a9272973f role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:57"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZS0RelNXw9Wm\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="executing paymentId change on the provider" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:64"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=info msg="Requesting GET api.stripe.com/v1/invoices\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=info msg="Request completed in 276.350435ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="retrieved invoice" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:119" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm INVOICE_ID=in_1KLWJBFqtLrMpqCWZDMgN9Fl STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJBFqtLrMpqCWZDMgN9Fl/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJBFqtLrMpqCWoMXyb2VW\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723585,\"start\":1643045185},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"subscription_item\":\"si_L1ZScRkZ3bFt6O\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"BD39B730-0001\",\"paid\":false,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJCFqtLrMpqCW0cJaBSm2\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045185,\"period_start\":1643045185,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045185,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJDFqtLrMpqCWW6PWlicG/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=info msg="Request completed in 802.647602ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:136" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm INVOICE_ID=in_1KLWJBFqtLrMpqCWZDMgN9Fl STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045188,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJDFqtLrMpqCWW6PWlicG\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZS0RelNXw9Wm\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=info msg="Request completed in 432.414125ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:155" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm INVOICE_ID=in_1KLWJBFqtLrMpqCWZDMgN9Fl STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045183,\"currency\":\"eur\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_7b65885f-a359-4f76-ab21-d0fb3c8f3ccd\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"BD39B730\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJDFqtLrMpqCWW6PWlicG\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":2,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/subscriptions\",\"data\":[{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045185,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"current_period_end\":1645723585,\"current_period_start\":1643045185,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045186,\"deleted\":false,\"id\":\"si_L1ZScRkZ3bFt6O\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045185,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0RelNXw9Wm/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=info msg="Requesting GET api.stripe.com/v1/invoices/in_1KLWJBFqtLrMpqCWZDMgN9Fl\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:30Z" level=info msg="Request completed in 376.731058ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:30Z" level=debug msg="invoice id updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:172" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm INVOICE_ID=in_1KLWJBFqtLrMpqCWZDMgN9Fl STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJBFqtLrMpqCWZDMgN9Fl/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJBFqtLrMpqCWoMXyb2VW\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723585,\"start\":1643045185},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"subscription_item\":\"si_L1ZScRkZ3bFt6O\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"BD39B730-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJCFqtLrMpqCW0cJaBSm2\",\"data\":[]},\"client_secret\":\"pi_3KLWJCFqtLrMpqCW0cJaBSm2_secret_9Cl3ZKwQKPKwSEw3fCBybGNEl\",\"confirmation_method\":\"automatic\",\"created\":1643045186,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJCFqtLrMpqCW0cJaBSm2\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJ9FqtLrMpqCWow0vT4Hj\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045185,\"period_start\":1643045185,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045185,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643045188,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:30Z" level=info msg="Requesting POST api.stripe.com/v1/invoices/in_1KLWJBFqtLrMpqCWZDMgN9Fl/pay\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="Request completed in 3.032964849s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="invoice paid" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:187" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm INVOICE_ID=in_1KLWJBFqtLrMpqCWZDMgN9Fl STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWJCFqtLrMpqCW0RXDdozH\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTY3lKbjhXODRndVFVUDY1RmczMmM3eHRDRXF501003b0dCzzs/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJBFqtLrMpqCWZDMgN9Fl/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJBFqtLrMpqCWoMXyb2VW\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723585,\"start\":1643045185},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"subscription_item\":\"si_L1ZScRkZ3bFt6O\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"BD39B730-0001\",\"paid\":true,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJCFqtLrMpqCW0cJaBSm2\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045185,\"period_start\":1643045185,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643045185,\"marked_uncollectible_at\":0,\"paid_at\":1643045190,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643045188,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJBFqtLrMpqCWSnaaNCkB\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="Request completed in 251.85865ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="subscription found" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:200" CUSTOMER_ID=cus_L1ZS0RelNXw9Wm INVOICE_ID=in_1KLWJBFqtLrMpqCWZDMgN9Fl STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045185,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045185,\"current_period_end\":1645723585,\"current_period_start\":1643045185,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0RelNXw9Wm\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045186,\"deleted\":false,\"id\":\"si_L1ZScRkZ3bFt6O\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJBFqtLrMpqCWSnaaNCkB\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJBFqtLrMpqCWZDMgN9Fl\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045185,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJBFqtLrMpqCWSnaaNCkB
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="update subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:74"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"c87ef685-27de-4864-bf69-1c9a9272973f\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="subscription retry done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:98" ACCOUNT_ID=c87ef685-27de-4864-bf69-1c9a9272973f CUSTOMER_ID=cus_L1ZS0RelNXw9Wm PLAN_ID=price_1IMKMvFqtLrMpqCW3mMM3mDS SUBSCRIPTION_ID=sub_1KLWJBFqtLrMpqCWSnaaNCkB
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=5215251316
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_c143b2f2-aa51-4ef0-ad35-7c3d69b0cf48\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="Request completed in 406.669193ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_c143b2f2-aa51-4ef0-ad35-7c3d69b0cf48 CUSTOMER_ID=cus_L1ZS0qkAg0kB3B STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045193,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_c143b2f2-aa51-4ef0-ad35-7c3d69b0cf48\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0qkAg0kB3B\",\"invoice_prefix\":\"B76BC11F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0qkAg0kB3B/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0qkAg0kB3B/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0qkAg0kB3B/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=430290312
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJKFqtLrMpqCWTQRv4a7V\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=01abd48c-f6e6-4136-b3e2-71f5211e9833 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJKFqtLrMpqCWTQRv4a7V/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:34Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=info msg="Request completed in 826.629302ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZS0qkAg0kB3B STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045194,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0qkAg0kB3B\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJKFqtLrMpqCWTQRv4a7V\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZS0qkAg0kB3B\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=info msg="Request completed in 464.780434ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZS0qkAg0kB3B STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045193,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_c143b2f2-aa51-4ef0-ad35-7c3d69b0cf48\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0qkAg0kB3B\",\"invoice_prefix\":\"B76BC11F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJKFqtLrMpqCWTQRv4a7V\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0qkAg0kB3B/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0qkAg0kB3B/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZS0qkAg0kB3B/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:35Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=info msg="Request completed in 2.306539352s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZS0qkAg0kB3B STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045195,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045195,\"current_period_end\":1645723595,\"current_period_start\":1643045195,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0qkAg0kB3B\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJMFqtLrMpqCWr2fJi86u\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJMFqtLrMpqCWr2fJi86u\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045196,\"deleted\":false,\"id\":\"si_L1ZSQWYcqSGnVY\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJMFqtLrMpqCWr2fJi86u\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045196,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0qkAg0kB3B\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTU1JwalVsU1hVbEE3RTZ5UG5xZjNFTzNIMTRL0100O5Tkgg8O\",\"id\":\"in_1KLWJMFqtLrMpqCWxSmox8YO\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTU1JwalVsU1hVbEE3RTZ5UG5xZjNFTzNIMTRL0100O5Tkgg8O/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJMFqtLrMpqCWxSmox8YO/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJMFqtLrMpqCW8LAEdg0G\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723595,\"start\":1643045195},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJMFqtLrMpqCWr2fJi86u\",\"subscription_item\":\"si_L1ZSQWYcqSGnVY\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"B76BC11F-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJMFqtLrMpqCW0gD8gmsI\",\"data\":[]},\"client_secret\":\"pi_3KLWJMFqtLrMpqCW0gD8gmsI_secret_m6TymHwm3DYpBy7rFLXJpJJDf\",\"confirmation_method\":\"automatic\",\"created\":1643045196,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZS0qkAg0kB3B\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJMFqtLrMpqCWxSmox8YO\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJMFqtLrMpqCW0gD8gmsI\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJKFqtLrMpqCWTQRv4a7V\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045195,\"period_start\":1643045195,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045195,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJMFqtLrMpqCWr2fJi86u\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045195,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJMFqtLrMpqCWr2fJi86u
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3627722277
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/change
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="change subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:52"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"id_plan\":\"premium\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="get stripe plan id" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func2" file="/app/pkg/subscription/handle_change.go:94"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:66"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=01abd48c-f6e6-4136-b3e2-71f5211e9833 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="GetStripePlanFromPlanID result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripePlanFromPlan file="/app/pkg/subscription/handle_utils.go:31" HASURA_RESPONSE="{\"subscription_plan\":[{\"stripe_code\":\"price_1IMKNbFqtLrMpqCWztWScMzg\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZS0qkAg0kB3B\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWJMFqtLrMpqCWr2fJi86u\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="update subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:115"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="getting subscription information from stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:155"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJMFqtLrMpqCWr2fJi86u\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWJMFqtLrMpqCWr2fJi86u
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWJMFqtLrMpqCWr2fJi86u
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJMFqtLrMpqCWr2fJi86u\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=info msg="Request completed in 261.168895ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="updating subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:162"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions/sub_1KLWJMFqtLrMpqCWr2fJi86u\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=info msg="Request completed in 406.432609ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWJMFqtLrMpqCWr2fJi86u
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"01abd48c-f6e6-4136-b3e2-71f5211e9833\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=info msg="Request completed in 1.049037789s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=error msg="Request error from Stripe (status 400): {\"status\":400,\"message\":\"You cannot update a subscription in `incomplete` status in a way that results in a new invoice or invoice items. Only minor attributes, like `metadata` or `default_payment_method`, can be updated on such subscriptions.\",\"request_id\":\"req_ECBacYkEI5eT1k\",\"type\":\"invalid_request_error\"}" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=error msg="not able to update subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:174" SUBSCRIPTION_ID=sub_1KLWJMFqtLrMpqCWr2fJi86u error="{\"status\":400,\"message\":\"You cannot update a subscription in `incomplete` status in a way that results in a new invoice or invoice items. Only minor attributes, like `metadata` or `default_payment_method`, can be updated on such subscriptions.\",\"request_id\":\"req_ECBacYkEI5eT1k\",\"type\":\"invalid_request_error\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1322022554
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_70a67291-5c05-426d-9155-267ecf85f7d1\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=info msg="Request completed in 411.371392ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_70a67291-5c05-426d-9155-267ecf85f7d1 CUSTOMER_ID=cus_L1ZSnEj6PKPBjz STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045199,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_70a67291-5c05-426d-9155-267ecf85f7d1\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"8B46213F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSnEj6PKPBjz/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSnEj6PKPBjz/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSnEj6PKPBjz/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:39Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=436007299
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJQFqtLrMpqCWQCRUSwaU\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=8560a9e8-bf11-44c4-abe5-c2af3b2c32b0 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:40Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJQFqtLrMpqCWQCRUSwaU/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=info msg="Request completed in 715.943054ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZSnEj6PKPBjz STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045200,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJQFqtLrMpqCWQCRUSwaU\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZSnEj6PKPBjz\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=info msg="Request completed in 420.893525ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZSnEj6PKPBjz STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045199,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_70a67291-5c05-426d-9155-267ecf85f7d1\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"8B46213F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJQFqtLrMpqCWQCRUSwaU\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSnEj6PKPBjz/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSnEj6PKPBjz/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSnEj6PKPBjz/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:41Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=info msg="Request completed in 2.492870657s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZSnEj6PKPBjz STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045201,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045201,\"current_period_end\":1645723601,\"current_period_start\":1643045201,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045202,\"deleted\":false,\"id\":\"si_L1ZS4PTy6IT8Bh\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045202,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTTjlrRHhaTk9ZWG5Za0E4UkJnR2JWRUlkYlh20100b0groarX\",\"id\":\"in_1KLWJSFqtLrMpqCWtOLmzFG9\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTTjlrRHhaTk9ZWG5Za0E4UkJnR2JWRUlkYlh20100b0groarX/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJSFqtLrMpqCWtOLmzFG9/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJSFqtLrMpqCWMzOogoRq\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723601,\"start\":1643045201},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"subscription_item\":\"si_L1ZS4PTy6IT8Bh\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"8B46213F-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJSFqtLrMpqCW1WitpYch\",\"data\":[]},\"client_secret\":\"pi_3KLWJSFqtLrMpqCW1WitpYch_secret_V27mINbqnbGkR4vv75JEl7bmE\",\"confirmation_method\":\"automatic\",\"created\":1643045202,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJSFqtLrMpqCWtOLmzFG9\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJSFqtLrMpqCW1WitpYch\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJQFqtLrMpqCWQCRUSwaU\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045201,\"period_start\":1643045201,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045201,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045201,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJSFqtLrMpqCWIs6brNhL
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3645288806
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/cancel
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="cancel subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:36"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:44"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=8560a9e8-bf11-44c4-abe5-c2af3b2c32b0 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="retrieving subscription id on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:51"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="GetStripeSubscription result" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).getStripeSubscriptionID" file="/app/pkg/subscription/handle_cancel.go:99" HASURA_RESPONSE="{\"subscription_status\":[{\"stripe_subscription_id\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="cancelling stripe subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:58"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=info msg="Requesting DELETE api.stripe.com/v1/subscriptions/sub_1KLWJSFqtLrMpqCWIs6brNhL\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWJSFqtLrMpqCWIs6brNhL
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWJSFqtLrMpqCWIs6brNhL
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJSFqtLrMpqCWIs6brNhL\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=info msg="Request completed in 264.54341ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWJSFqtLrMpqCWIs6brNhL
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:44Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=info msg="Request completed in 1.631781208s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).cancelStripeSubscription" file="/app/pkg/subscription/handle_cancel.go:120" ACCOUNT_ID=8560a9e8-bf11-44c4-abe5-c2af3b2c32b0 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045201,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":1643045205,\"collection_method\":\"charge_automatically\",\"created\":1643045201,\"current_period_end\":1645723601,\"current_period_start\":1643045201,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSnEj6PKPBjz\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":1643045205,\"id\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045202,\"deleted\":false,\"id\":\"si_L1ZS4PTy6IT8Bh\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJSFqtLrMpqCWIs6brNhL\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJSFqtLrMpqCWtOLmzFG9\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045201,\"status\":\"incomplete_expired\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJSFqtLrMpqCWIs6brNhL
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="updating hasura with the cancellation status" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:65"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"8560a9e8-bf11-44c4-abe5-c2af3b2c32b0\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete_expired\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:72"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"status\":\"incomplete_expired\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1655278941
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_51d8929e-fb35-4289-9b76-55454c5d717c\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.canceled
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:45Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=payment_intent.canceled
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=info msg="Request completed in 385.79637ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_51d8929e-fb35-4289-9b76-55454c5d717c CUSTOMER_ID=cus_L1ZSQkGyOoXOym STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045205,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_51d8929e-fb35-4289-9b76-55454c5d717c\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQkGyOoXOym\",\"invoice_prefix\":\"BE052042\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQkGyOoXOym/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQkGyOoXOym/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQkGyOoXOym/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"43027dbd-a953-415f-91b8-4e5df2fe16b6\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=403916952
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.voided
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.voided
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"43027dbd-a953-415f-91b8-4e5df2fe16b6\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWJWFqtLrMpqCWoWi5W41w\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=43027dbd-a953-415f-91b8-4e5df2fe16b6 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:46Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWJWFqtLrMpqCWoWi5W41w/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=info msg="Request completed in 820.714096ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZSQkGyOoXOym STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045206,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQkGyOoXOym\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWJWFqtLrMpqCWoWi5W41w\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZSQkGyOoXOym\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=info msg="Request completed in 401.209697ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZSQkGyOoXOym STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045205,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_51d8929e-fb35-4289-9b76-55454c5d717c\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQkGyOoXOym\",\"invoice_prefix\":\"BE052042\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJWFqtLrMpqCWoWi5W41w\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQkGyOoXOym/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQkGyOoXOym/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQkGyOoXOym/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="Request completed in 2.365620024s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZSQkGyOoXOym STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045208,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045208,\"current_period_end\":1645723608,\"current_period_start\":1643045208,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQkGyOoXOym\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJYFqtLrMpqCWPlgLmIDy\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWJYFqtLrMpqCWPlgLmIDy\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045208,\"deleted\":false,\"id\":\"si_L1ZSDqNn6x0FHq\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWJYFqtLrMpqCWPlgLmIDy\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045208,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQkGyOoXOym\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTeXkxOUFyNFdRRW90eWxaYXdjdG9FdGZ0OFo00100hhM8avhj\",\"id\":\"in_1KLWJYFqtLrMpqCWsOYYFJKx\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpTeXkxOUFyNFdRRW90eWxaYXdjdG9FdGZ0OFo00100hhM8avhj/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWJYFqtLrMpqCWsOYYFJKx/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWJYFqtLrMpqCWSeAbLiwP\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723608,\"start\":1643045208},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWJYFqtLrMpqCWPlgLmIDy\",\"subscription_item\":\"si_L1ZSDqNn6x0FHq\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"BE052042-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWJZFqtLrMpqCW01oc3k43\",\"data\":[]},\"client_secret\":\"pi_3KLWJZFqtLrMpqCW01oc3k43_secret_ipMjODsOUnFgUNRmhGrFthKZB\",\"confirmation_method\":\"automatic\",\"created\":1643045209,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQkGyOoXOym\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWJYFqtLrMpqCWsOYYFJKx\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWJZFqtLrMpqCW01oc3k43\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWJWFqtLrMpqCWoWi5W41w\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045208,\"period_start\":1643045208,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045208,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWJYFqtLrMpqCWPlgLmIDy\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045208,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWJYFqtLrMpqCWPlgLmIDy
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"43027dbd-a953-415f-91b8-4e5df2fe16b6\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"43027dbd-a953-415f-91b8-4e5df2fe16b6\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3619144520
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_0d3b4026-b9f6-4398-b1c4-4470e25e7fe0\",\"id_plan\":\"free\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWJYFqtLrMpqCWPlgLmIDy
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWJYFqtLrMpqCWPlgLmIDy
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWJYFqtLrMpqCWPlgLmIDy\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="Request completed in 362.817424ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_0d3b4026-b9f6-4398-b1c4-4470e25e7fe0 CUSTOMER_ID=cus_L1ZSQBOzEvVqJJ STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045210,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_0d3b4026-b9f6-4398-b1c4-4470e25e7fe0\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSQBOzEvVqJJ\",\"invoice_prefix\":\"C4F5FAEA\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQBOzEvVqJJ/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQBOzEvVqJJ/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSQBOzEvVqJJ/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"f87790f8-d4f7-4061-b4b8-1703b7f692bb\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=380706178
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:52676" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"f87790f8-d4f7-4061-b4b8-1703b7f692bb\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=f87790f8-d4f7-4061-b4b8-1703b7f692bb role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:26:50 http: panic serving 172.26.0.3:52676: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 176 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc0000de000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc000372000, 0xc0003f6d00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc000372000, 0xc0003f6d00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc000372000, 0xc0003f6c00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc000372000, 0xc0003f6b00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc000372000, 0xc0003f6a00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc000372000, 0xc0003f6a00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc000372000, 0xc0003f6800)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc000372000, 0xc0003f6800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc000372000, 0xc0003f6800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc0000de000, 0x908440, 0xc000212000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53002" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"f87790f8-d4f7-4061-b4b8-1703b7f692bb\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=f87790f8-d4f7-4061-b4b8-1703b7f692bb role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:26:50 http: panic serving 172.26.0.3:53002: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 305 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc0000de5a0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0003722a0, 0xc0003f7300)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0003722a0, 0xc0003f7300)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0003722a0, 0xc0003f7200)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0003722a0, 0xc0003f7100)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0003722a0, 0xc0003f7000)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0003722a0, 0xc0003f7000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0003722a0, 0xc0003f6e00)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0003722a0, 0xc0003f6e00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0003722a0, 0xc0003f6e00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc0000de5a0, 0x908440, 0xc0003f46c0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53004" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_07a89f70-b0cb-48a1-ac58-57e730b69ecb\",\"id_plan\":\"basic_trial\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=info msg="Request completed in 280.992267ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWJYFqtLrMpqCWPlgLmIDy
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"43027dbd-a953-415f-91b8-4e5df2fe16b6\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=info msg="Request completed in 429.776211ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_07a89f70-b0cb-48a1-ac58-57e730b69ecb CUSTOMER_ID=cus_L1ZSBeuNMTSQ0H STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045211,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_07a89f70-b0cb-48a1-ac58-57e730b69ecb\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSBeuNMTSQ0H\",\"invoice_prefix\":\"CFA68D1E\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSBeuNMTSQ0H/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSBeuNMTSQ0H/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSBeuNMTSQ0H/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"bfacef32-e1aa-4d7c-b162-f85c3bd08f0e\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=452414325
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53004" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"bfacef32-e1aa-4d7c-b162-f85c3bd08f0e\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=bfacef32-e1aa-4d7c-b162-f85c3bd08f0e role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:26:51 http: panic serving 172.26.0.3:53004: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 339 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc0000de780)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0002920e0, 0xc00029a700)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0002920e0, 0xc00029a700)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0002920e0, 0xc00029a600)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0002920e0, 0xc00029a500)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0002920e0, 0xc00029a400)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0002920e0, 0xc00029a400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0002920e0, 0xc00029a200)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0002920e0, 0xc00029a200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0002920e0, 0xc00029a200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc0000de780, 0x908440, 0xc000213700)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53010" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"bfacef32-e1aa-4d7c-b162-f85c3bd08f0e\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=bfacef32-e1aa-4d7c-b162-f85c3bd08f0e role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:26:51 http: panic serving 172.26.0.3:53010: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 329 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc000023900)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc000292380, 0xc00029ad00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc000292380, 0xc00029ad00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc000292380, 0xc00029ac00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc000292380, 0xc00029ab00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc000292380, 0xc00029aa00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc000292380, 0xc00029aa00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc000292380, 0xc00029a800)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc000292380, 0xc00029a800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc000292380, 0xc00029a800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc000023900, 0x908440, 0xc000096c80)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:26:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_d71e5927-e178-4ba9-8277-2bc18b039713\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:17Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=info msg="Request completed in 402.330944ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_d71e5927-e178-4ba9-8277-2bc18b039713 CUSTOMER_ID=cus_L1ZSzhQ9uU62jW STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045237,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_d71e5927-e178-4ba9-8277-2bc18b039713\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSzhQ9uU62jW\",\"invoice_prefix\":\"9ABEDB85\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSzhQ9uU62jW/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSzhQ9uU62jW/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSzhQ9uU62jW/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"23f85256-25e1-4d74-8936-cda9504a3d32\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=429983309
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:18Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"23f85256-25e1-4d74-8936-cda9504a3d32\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWK2FqtLrMpqCWlmc2H6ER\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=23f85256-25e1-4d74-8936-cda9504a3d32 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWK2FqtLrMpqCWlmc2H6ER/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=info msg="Request completed in 763.560336ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZSzhQ9uU62jW STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045238,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSzhQ9uU62jW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWK2FqtLrMpqCWlmc2H6ER\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:19Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZSzhQ9uU62jW\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:20Z" level=info msg="Request completed in 473.024263ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:20Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZSzhQ9uU62jW STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045237,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_d71e5927-e178-4ba9-8277-2bc18b039713\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSzhQ9uU62jW\",\"invoice_prefix\":\"9ABEDB85\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWK2FqtLrMpqCWlmc2H6ER\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSzhQ9uU62jW/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSzhQ9uU62jW/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZSzhQ9uU62jW/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:20Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=info msg="Request completed in 2.192242204s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZSzhQ9uU62jW STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045240,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045240,\"current_period_end\":1645723640,\"current_period_start\":1643045240,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSzhQ9uU62jW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWK4FqtLrMpqCWn1xCB6BY\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWK4FqtLrMpqCWn1xCB6BY\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045241,\"deleted\":false,\"id\":\"si_L1ZTztE8uhGn7v\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWK4FqtLrMpqCWn1xCB6BY\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045240,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSzhQ9uU62jW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpURzlSU2RsQXB5UnNvdFFtU2RlaTRYbVVTcG1W0100y35fBA2O\",\"id\":\"in_1KLWK4FqtLrMpqCWLR053cOI\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpURzlSU2RsQXB5UnNvdFFtU2RlaTRYbVVTcG1W0100y35fBA2O/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWK4FqtLrMpqCWLR053cOI/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWK4FqtLrMpqCWzREcFP7p\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723640,\"start\":1643045240},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWK4FqtLrMpqCWn1xCB6BY\",\"subscription_item\":\"si_L1ZTztE8uhGn7v\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"9ABEDB85-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWK5FqtLrMpqCW0uCgN5Vd\",\"data\":[]},\"client_secret\":\"pi_3KLWK5FqtLrMpqCW0uCgN5Vd_secret_s2Tk4U7ZM6YetHEgbl05QDSpw\",\"confirmation_method\":\"automatic\",\"created\":1643045241,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZSzhQ9uU62jW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWK4FqtLrMpqCWLR053cOI\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWK5FqtLrMpqCW0uCgN5Vd\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWK2FqtLrMpqCWlmc2H6ER\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045240,\"period_start\":1643045240,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045240,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWK4FqtLrMpqCWn1xCB6BY\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045240,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWK4FqtLrMpqCWn1xCB6BY
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"23f85256-25e1-4d74-8936-cda9504a3d32\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"23f85256-25e1-4d74-8936-cda9504a3d32\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3452491427
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_02d33b95-c33f-4056-9d1d-5de5e448036e\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWK4FqtLrMpqCWn1xCB6BY
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWK4FqtLrMpqCWn1xCB6BY
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWK4FqtLrMpqCWn1xCB6BY\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:22Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=info msg="Request completed in 405.308186ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_02d33b95-c33f-4056-9d1d-5de5e448036e CUSTOMER_ID=cus_L1ZTRjfAhDkBzq STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045242,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_02d33b95-c33f-4056-9d1d-5de5e448036e\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTRjfAhDkBzq\",\"invoice_prefix\":\"D1C7E890\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTRjfAhDkBzq/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTRjfAhDkBzq/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTRjfAhDkBzq/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"4a0e4f55-a9b7-41ef-b5db-0998d387397f\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=418442666
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=info msg="Request completed in 281.893591ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWK4FqtLrMpqCWn1xCB6BY
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"23f85256-25e1-4d74-8936-cda9504a3d32\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"4a0e4f55-a9b7-41ef-b5db-0998d387397f\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWK7FqtLrMpqCWGgXjI6Rw\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=4a0e4f55-a9b7-41ef-b5db-0998d387397f role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:23Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWK7FqtLrMpqCWGgXjI6Rw/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=info msg="Request completed in 748.022655ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZTRjfAhDkBzq STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045243,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTRjfAhDkBzq\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWK7FqtLrMpqCWGgXjI6Rw\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZTRjfAhDkBzq\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=info msg="Request completed in 403.899905ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZTRjfAhDkBzq STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045242,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_02d33b95-c33f-4056-9d1d-5de5e448036e\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTRjfAhDkBzq\",\"invoice_prefix\":\"D1C7E890\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWK7FqtLrMpqCWGgXjI6Rw\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTRjfAhDkBzq/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTRjfAhDkBzq/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTRjfAhDkBzq/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=info msg="Request completed in 2.295645717s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZTRjfAhDkBzq STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045244,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045244,\"current_period_end\":1645723644,\"current_period_start\":1643045244,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTRjfAhDkBzq\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWK9FqtLrMpqCWIGNHvbTw\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWK9FqtLrMpqCWIGNHvbTw\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045245,\"deleted\":false,\"id\":\"si_L1ZTFOv3XgxFC2\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWK9FqtLrMpqCWIGNHvbTw\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045245,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTRjfAhDkBzq\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUcjE1bncyQWZ5UFhVelcyWGpIQ0tibVRmNldo0100adjGqvs3\",\"id\":\"in_1KLWK9FqtLrMpqCWDeTgmOEX\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUcjE1bncyQWZ5UFhVelcyWGpIQ0tibVRmNldo0100adjGqvs3/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWK9FqtLrMpqCWDeTgmOEX/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWK9FqtLrMpqCW5z0tx0U3\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723644,\"start\":1643045244},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWK9FqtLrMpqCWIGNHvbTw\",\"subscription_item\":\"si_L1ZTFOv3XgxFC2\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D1C7E890-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWK9FqtLrMpqCW0AFCwkJ5\",\"data\":[]},\"client_secret\":\"pi_3KLWK9FqtLrMpqCW0AFCwkJ5_secret_BlDwCafVlPUHL29nReiUYp0Ob\",\"confirmation_method\":\"automatic\",\"created\":1643045245,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTRjfAhDkBzq\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWK9FqtLrMpqCWDeTgmOEX\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWK9FqtLrMpqCW0AFCwkJ5\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWK7FqtLrMpqCWGgXjI6Rw\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045244,\"period_start\":1643045244,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045244,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWK9FqtLrMpqCWIGNHvbTw\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045244,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWK9FqtLrMpqCWIGNHvbTw
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"4a0e4f55-a9b7-41ef-b5db-0998d387397f\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"4a0e4f55-a9b7-41ef-b5db-0998d387397f\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3477537650
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_130dd1e1-5f2e-48aa-b55a-6c69c0e0924d\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWK9FqtLrMpqCWIGNHvbTw
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWK9FqtLrMpqCWIGNHvbTw
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWK9FqtLrMpqCWIGNHvbTw\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=info msg="Request completed in 271.549207ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWK9FqtLrMpqCWIGNHvbTw
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"4a0e4f55-a9b7-41ef-b5db-0998d387397f\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=info msg="Request completed in 486.731284ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_130dd1e1-5f2e-48aa-b55a-6c69c0e0924d CUSTOMER_ID=cus_L1ZTOoEl6FW3fk STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045247,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_130dd1e1-5f2e-48aa-b55a-6c69c0e0924d\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"D25B9FE2\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=507265412
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWKBFqtLrMpqCW5MAxtmpZ\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7d78035a-f5c5-457a-bbc2-5fb924f12ea2 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWKBFqtLrMpqCW5MAxtmpZ/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=info msg="Request completed in 897.241671ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045248,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWKBFqtLrMpqCW5MAxtmpZ\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZTOoEl6FW3fk\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=info msg="Request completed in 377.480919ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045247,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_130dd1e1-5f2e-48aa-b55a-6c69c0e0924d\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"D25B9FE2\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKBFqtLrMpqCW5MAxtmpZ\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=info msg="Request completed in 2.106757928s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045249,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"current_period_end\":1645723649,\"current_period_start\":1643045249,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045250,\"deleted\":false,\"id\":\"si_L1ZTQ8a8FRPwlh\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKDFqtLrMpqCWoCU40Df1/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKDFqtLrMpqCWWbeGu3ge\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723649,\"start\":1643045249},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"subscription_item\":\"si_L1ZTQ8a8FRPwlh\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D25B9FE2-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWKEFqtLrMpqCW0H794UAw\",\"data\":[]},\"client_secret\":\"pi_3KLWKEFqtLrMpqCW0H794UAw_secret_olyeEX89LX9b36xeg5vyTBNJ8\",\"confirmation_method\":\"automatic\",\"created\":1643045250,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKEFqtLrMpqCW0H794UAw\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKBFqtLrMpqCW5MAxtmpZ\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045249,\"period_start\":1643045249,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045249,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045249,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWKDFqtLrMpqCWhq7ivf7Z
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3411956649
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWKDFqtLrMpqCWhq7ivf7Z
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWKDFqtLrMpqCWhq7ivf7Z
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:31Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWKDFqtLrMpqCWhq7ivf7Z\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=info msg="Request completed in 274.015948ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWKDFqtLrMpqCWhq7ivf7Z
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/retry
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="retry subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:42"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWKFFqtLrMpqCWPmRm2FUd\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:50"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7d78035a-f5c5-457a-bbc2-5fb924f12ea2 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:57"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZTOoEl6FW3fk\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="executing paymentId change on the provider" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:64"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=info msg="Requesting GET api.stripe.com/v1/invoices\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=info msg="Request completed in 279.244599ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="retrieved invoice" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:119" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk INVOICE_ID=in_1KLWKDFqtLrMpqCWoCU40Df1 STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKDFqtLrMpqCWoCU40Df1/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKDFqtLrMpqCWWbeGu3ge\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723649,\"start\":1643045249},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"subscription_item\":\"si_L1ZTQ8a8FRPwlh\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D25B9FE2-0001\",\"paid\":false,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKEFqtLrMpqCW0H794UAw\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045249,\"period_start\":1643045249,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045249,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWKFFqtLrMpqCWPmRm2FUd/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=info msg="Request completed in 825.317837ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:136" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk INVOICE_ID=in_1KLWKDFqtLrMpqCWoCU40Df1 STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045252,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWKFFqtLrMpqCWPmRm2FUd\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZTOoEl6FW3fk\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=info msg="Request completed in 473.263843ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:155" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk INVOICE_ID=in_1KLWKDFqtLrMpqCWoCU40Df1 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045247,\"currency\":\"eur\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_130dd1e1-5f2e-48aa-b55a-6c69c0e0924d\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"D25B9FE2\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKFFqtLrMpqCWPmRm2FUd\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":2,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/subscriptions\",\"data\":[{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045249,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"current_period_end\":1645723649,\"current_period_start\":1643045249,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045250,\"deleted\":false,\"id\":\"si_L1ZTQ8a8FRPwlh\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045249,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTOoEl6FW3fk/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:33Z" level=info msg="Requesting GET api.stripe.com/v1/invoices/in_1KLWKDFqtLrMpqCWoCU40Df1\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=info msg="Request completed in 330.594601ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=debug msg="invoice id updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:172" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk INVOICE_ID=in_1KLWKDFqtLrMpqCWoCU40Df1 STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKDFqtLrMpqCWoCU40Df1/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKDFqtLrMpqCWWbeGu3ge\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723649,\"start\":1643045249},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"subscription_item\":\"si_L1ZTQ8a8FRPwlh\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D25B9FE2-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWKEFqtLrMpqCW0H794UAw\",\"data\":[]},\"client_secret\":\"pi_3KLWKEFqtLrMpqCW0H794UAw_secret_olyeEX89LX9b36xeg5vyTBNJ8\",\"confirmation_method\":\"automatic\",\"created\":1643045250,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKEFqtLrMpqCW0H794UAw\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKBFqtLrMpqCW5MAxtmpZ\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045249,\"period_start\":1643045249,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045249,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643045252,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:34Z" level=info msg="Requesting POST api.stripe.com/v1/invoices/in_1KLWKDFqtLrMpqCWoCU40Df1/pay\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=info msg="Request completed in 2.366910287s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="invoice paid" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:187" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk INVOICE_ID=in_1KLWKDFqtLrMpqCWoCU40Df1 STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWKEFqtLrMpqCW0XfdQyIh\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUOTFFU3lwa0V5MDhLTEFQMjVHSzJ2Z2lrQWJz0100Hd3oxHOP/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKDFqtLrMpqCWoCU40Df1/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKDFqtLrMpqCWWbeGu3ge\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723649,\"start\":1643045249},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"subscription_item\":\"si_L1ZTQ8a8FRPwlh\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D25B9FE2-0001\",\"paid\":true,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKEFqtLrMpqCW0H794UAw\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045249,\"period_start\":1643045249,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643045249,\"marked_uncollectible_at\":0,\"paid_at\":1643045254,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643045252,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWKDFqtLrMpqCWhq7ivf7Z\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=info msg="Request completed in 254.075147ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="subscription found" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:200" CUSTOMER_ID=cus_L1ZTOoEl6FW3fk INVOICE_ID=in_1KLWKDFqtLrMpqCWoCU40Df1 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045249,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045249,\"current_period_end\":1645723649,\"current_period_start\":1643045249,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTOoEl6FW3fk\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045250,\"deleted\":false,\"id\":\"si_L1ZTQ8a8FRPwlh\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKDFqtLrMpqCWhq7ivf7Z\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKDFqtLrMpqCWoCU40Df1\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045249,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWKDFqtLrMpqCWhq7ivf7Z
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="update subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:74"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7d78035a-f5c5-457a-bbc2-5fb924f12ea2\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=info msg="subscription retry done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:98" ACCOUNT_ID=7d78035a-f5c5-457a-bbc2-5fb924f12ea2 CUSTOMER_ID=cus_L1ZTOoEl6FW3fk PLAN_ID=price_1IMKMvFqtLrMpqCW3mMM3mDS SUBSCRIPTION_ID=sub_1KLWKDFqtLrMpqCWhq7ivf7Z
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4560151177
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_358cf44f-e7a2-49ef-a0f9-7181e2095170\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:36Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=info msg="Request completed in 398.506869ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_358cf44f-e7a2-49ef-a0f9-7181e2095170 CUSTOMER_ID=cus_L1ZTW6zEAz6aCZ STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045256,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_358cf44f-e7a2-49ef-a0f9-7181e2095170\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTW6zEAz6aCZ\",\"invoice_prefix\":\"69805F2F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTW6zEAz6aCZ/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTW6zEAz6aCZ/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTW6zEAz6aCZ/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=417078588
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWKLFqtLrMpqCWiGz5q9y1\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=d3123336-bd1c-4a86-8764-f4f83340dd66 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:37Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWKLFqtLrMpqCWiGz5q9y1/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=info msg="Request completed in 794.948145ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZTW6zEAz6aCZ STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045257,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTW6zEAz6aCZ\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWKLFqtLrMpqCWiGz5q9y1\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZTW6zEAz6aCZ\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=info msg="Request completed in 440.468592ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZTW6zEAz6aCZ STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045256,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_358cf44f-e7a2-49ef-a0f9-7181e2095170\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTW6zEAz6aCZ\",\"invoice_prefix\":\"69805F2F\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKLFqtLrMpqCWiGz5q9y1\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTW6zEAz6aCZ/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTW6zEAz6aCZ/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTW6zEAz6aCZ/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=info msg="Request completed in 2.331881311s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZTW6zEAz6aCZ STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045259,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045259,\"current_period_end\":1645723659,\"current_period_start\":1643045259,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTW6zEAz6aCZ\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKNFqtLrMpqCWRHWjdlYe\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKNFqtLrMpqCWRHWjdlYe\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045259,\"deleted\":false,\"id\":\"si_L1ZTsohVnMAzHe\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKNFqtLrMpqCWRHWjdlYe\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045259,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTW6zEAz6aCZ\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUZXFCaUQyc1N2Y3QzZ2tIbHV1UlgxdWpBMVZF0100ZMfjlJY7\",\"id\":\"in_1KLWKNFqtLrMpqCWfAARvuvA\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUZXFCaUQyc1N2Y3QzZ2tIbHV1UlgxdWpBMVZF0100ZMfjlJY7/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKNFqtLrMpqCWfAARvuvA/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKNFqtLrMpqCWVCibtI0u\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723659,\"start\":1643045259},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKNFqtLrMpqCWRHWjdlYe\",\"subscription_item\":\"si_L1ZTsohVnMAzHe\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"69805F2F-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWKNFqtLrMpqCW03WxGBnX\",\"data\":[]},\"client_secret\":\"pi_3KLWKNFqtLrMpqCW03WxGBnX_secret_PtSacVOXNuF4Dkzlk9urvdafD\",\"confirmation_method\":\"automatic\",\"created\":1643045259,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTW6zEAz6aCZ\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKNFqtLrMpqCWfAARvuvA\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKNFqtLrMpqCW03WxGBnX\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKLFqtLrMpqCWiGz5q9y1\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045259,\"period_start\":1643045259,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045259,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKNFqtLrMpqCWRHWjdlYe\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045259,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWKNFqtLrMpqCWRHWjdlYe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3598765939
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/change
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="change subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:52"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"id_plan\":\"premium\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="get stripe plan id" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func2" file="/app/pkg/subscription/handle_change.go:94"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:66"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=d3123336-bd1c-4a86-8764-f4f83340dd66 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="GetStripePlanFromPlanID result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripePlanFromPlan file="/app/pkg/subscription/handle_utils.go:31" HASURA_RESPONSE="{\"subscription_plan\":[{\"stripe_code\":\"price_1IMKNbFqtLrMpqCWztWScMzg\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZTW6zEAz6aCZ\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWKNFqtLrMpqCWRHWjdlYe\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="update subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:115"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="getting subscription information from stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:155"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWKNFqtLrMpqCWRHWjdlYe\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWKNFqtLrMpqCWRHWjdlYe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWKNFqtLrMpqCWRHWjdlYe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWKNFqtLrMpqCWRHWjdlYe\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=info msg="Request completed in 261.138641ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="updating subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:162"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions/sub_1KLWKNFqtLrMpqCWRHWjdlYe\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=info msg="Request completed in 268.518288ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWKNFqtLrMpqCWRHWjdlYe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:41Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"d3123336-bd1c-4a86-8764-f4f83340dd66\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=info msg="Request completed in 963.727197ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=error msg="Request error from Stripe (status 400): {\"status\":400,\"message\":\"You cannot update a subscription in `incomplete` status in a way that results in a new invoice or invoice items. Only minor attributes, like `metadata` or `default_payment_method`, can be updated on such subscriptions.\",\"request_id\":\"req_wEbw4HEyvYXBsw\",\"type\":\"invalid_request_error\"}" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=error msg="not able to update subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:174" SUBSCRIPTION_ID=sub_1KLWKNFqtLrMpqCWRHWjdlYe error="{\"status\":400,\"message\":\"You cannot update a subscription in `incomplete` status in a way that results in a new invoice or invoice items. Only minor attributes, like `metadata` or `default_payment_method`, can be updated on such subscriptions.\",\"request_id\":\"req_wEbw4HEyvYXBsw\",\"type\":\"invalid_request_error\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1234820597
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_60a74074-62f8-4e2e-b937-5f885c138fd1\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:42Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=info msg="Request completed in 390.956444ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_60a74074-62f8-4e2e-b937-5f885c138fd1 CUSTOMER_ID=cus_L1ZTDraX6CuURn STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045262,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_60a74074-62f8-4e2e-b937-5f885c138fd1\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"FEB0E6CC\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTDraX6CuURn/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTDraX6CuURn/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTDraX6CuURn/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=416591867
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWKRFqtLrMpqCWr7f4Gc8T\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=dfabe967-6e47-4d71-a2bc-e0bc9ae601d4 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:43Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWKRFqtLrMpqCWr7f4Gc8T/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=info msg="Request completed in 977.531241ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZTDraX6CuURn STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045263,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWKRFqtLrMpqCWr7f4Gc8T\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZTDraX6CuURn\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:44Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=info msg="Request completed in 453.625754ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZTDraX6CuURn STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045262,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_60a74074-62f8-4e2e-b937-5f885c138fd1\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"FEB0E6CC\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKRFqtLrMpqCWr7f4Gc8T\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTDraX6CuURn/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTDraX6CuURn/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTDraX6CuURn/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:45Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=info msg="Request completed in 2.365334098s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZTDraX6CuURn STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045265,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045265,\"current_period_end\":1645723665,\"current_period_start\":1643045265,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045265,\"deleted\":false,\"id\":\"si_L1ZTO6ByW9uNo5\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045265,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUSnl5Z2U0UzNpdDFDODI0dWE3aGh5SHZFajlR0100Xi1GHpzJ\",\"id\":\"in_1KLWKTFqtLrMpqCWwcAtouxd\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUSnl5Z2U0UzNpdDFDODI0dWE3aGh5SHZFajlR0100Xi1GHpzJ/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKTFqtLrMpqCWwcAtouxd/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKTFqtLrMpqCWsoNFRO9s\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723665,\"start\":1643045265},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"subscription_item\":\"si_L1ZTO6ByW9uNo5\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"FEB0E6CC-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWKUFqtLrMpqCW0d2EAwEi\",\"data\":[]},\"client_secret\":\"pi_3KLWKUFqtLrMpqCW0d2EAwEi_secret_lezttOSnHfCX80xa01CYZ17rU\",\"confirmation_method\":\"automatic\",\"created\":1643045266,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKTFqtLrMpqCWwcAtouxd\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKUFqtLrMpqCW0d2EAwEi\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKRFqtLrMpqCWr7f4Gc8T\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045265,\"period_start\":1643045265,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045265,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045265,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWKTFqtLrMpqCWOvnGteIm
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3832336555
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/cancel
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="cancel subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:36"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:44"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=dfabe967-6e47-4d71-a2bc-e0bc9ae601d4 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="retrieving subscription id on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:51"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="GetStripeSubscription result" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).getStripeSubscriptionID" file="/app/pkg/subscription/handle_cancel.go:99" HASURA_RESPONSE="{\"subscription_status\":[{\"stripe_subscription_id\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="cancelling stripe subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:58"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=info msg="Requesting DELETE api.stripe.com/v1/subscriptions/sub_1KLWKTFqtLrMpqCWOvnGteIm\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWKTFqtLrMpqCWOvnGteIm
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWKTFqtLrMpqCWOvnGteIm
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWKTFqtLrMpqCWOvnGteIm\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=info msg="Request completed in 385.805247ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWKTFqtLrMpqCWOvnGteIm
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=info msg="Request completed in 1.609881326s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).cancelStripeSubscription" file="/app/pkg/subscription/handle_cancel.go:120" ACCOUNT_ID=dfabe967-6e47-4d71-a2bc-e0bc9ae601d4 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045265,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":1643045268,\"collection_method\":\"charge_automatically\",\"created\":1643045265,\"current_period_end\":1645723665,\"current_period_start\":1643045265,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTDraX6CuURn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":1643045268,\"id\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045265,\"deleted\":false,\"id\":\"si_L1ZTO6ByW9uNo5\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKTFqtLrMpqCWOvnGteIm\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKTFqtLrMpqCWwcAtouxd\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045265,\"status\":\"incomplete_expired\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWKTFqtLrMpqCWOvnGteIm
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="updating hasura with the cancellation status" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:65"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"dfabe967-6e47-4d71-a2bc-e0bc9ae601d4\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete_expired\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:72"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"status\":\"incomplete_expired\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1627394391
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_ef12d88d-244b-4862-82da-f395dc89bace\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.canceled
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=payment_intent.canceled
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=info msg="Request completed in 405.628188ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_ef12d88d-244b-4862-82da-f395dc89bace CUSTOMER_ID=cus_L1ZTSLJV6xHAeT STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045269,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_ef12d88d-244b-4862-82da-f395dc89bace\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTSLJV6xHAeT\",\"invoice_prefix\":\"5744CB16\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTSLJV6xHAeT/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTSLJV6xHAeT/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTSLJV6xHAeT/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.voided
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"24e76276-ab6d-4cd1-9f5c-0f3f2fc512f6\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=429549085
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.voided
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:49Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"24e76276-ab6d-4cd1-9f5c-0f3f2fc512f6\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWKXFqtLrMpqCWliRD1plr\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=24e76276-ab6d-4cd1-9f5c-0f3f2fc512f6 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWKXFqtLrMpqCWliRD1plr/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=info msg="Request completed in 648.747937ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZTSLJV6xHAeT STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045269,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTSLJV6xHAeT\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWKXFqtLrMpqCWliRD1plr\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZTSLJV6xHAeT\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=info msg="Request completed in 423.192781ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZTSLJV6xHAeT STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045269,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_ef12d88d-244b-4862-82da-f395dc89bace\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTSLJV6xHAeT\",\"invoice_prefix\":\"5744CB16\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKXFqtLrMpqCWliRD1plr\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTSLJV6xHAeT/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTSLJV6xHAeT/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTSLJV6xHAeT/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="Request completed in 2.271222331s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZTSLJV6xHAeT STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045271,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045271,\"current_period_end\":1645723671,\"current_period_start\":1643045271,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTSLJV6xHAeT\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKZFqtLrMpqCWyrPVJb5e\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWKZFqtLrMpqCWyrPVJb5e\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045271,\"deleted\":false,\"id\":\"si_L1ZTnRvDtTUH1D\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWKZFqtLrMpqCWyrPVJb5e\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045271,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTSLJV6xHAeT\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUc0IyYUZFdlNRV1BndWVrQ1ZsQVNIT2Q5aEJr0100OTBI5nkJ\",\"id\":\"in_1KLWKZFqtLrMpqCW0W2E8uNS\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpUc0IyYUZFdlNRV1BndWVrQ1ZsQVNIT2Q5aEJr0100OTBI5nkJ/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWKZFqtLrMpqCW0W2E8uNS/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWKZFqtLrMpqCWheCialtC\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723671,\"start\":1643045271},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWKZFqtLrMpqCWyrPVJb5e\",\"subscription_item\":\"si_L1ZTnRvDtTUH1D\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"5744CB16-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWKaFqtLrMpqCW08V4mynW\",\"data\":[]},\"client_secret\":\"pi_3KLWKaFqtLrMpqCW08V4mynW_secret_QdzP0wIPTCpd8PsuXFtm9uGeB\",\"confirmation_method\":\"automatic\",\"created\":1643045272,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTSLJV6xHAeT\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWKZFqtLrMpqCW0W2E8uNS\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWKaFqtLrMpqCW08V4mynW\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWKXFqtLrMpqCWliRD1plr\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045271,\"period_start\":1643045271,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045271,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWKZFqtLrMpqCWyrPVJb5e\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045271,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWKZFqtLrMpqCWyrPVJb5e
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"24e76276-ab6d-4cd1-9f5c-0f3f2fc512f6\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"24e76276-ab6d-4cd1-9f5c-0f3f2fc512f6\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3379746094
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_e67fe882-90c0-4d2f-bb89-33e2567a687e\",\"id_plan\":\"free\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWKZFqtLrMpqCWyrPVJb5e
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWKZFqtLrMpqCWyrPVJb5e
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWKZFqtLrMpqCWyrPVJb5e\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="Request completed in 369.094127ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_e67fe882-90c0-4d2f-bb89-33e2567a687e CUSTOMER_ID=cus_L1ZTnbAZtvoEOe STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045273,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_e67fe882-90c0-4d2f-bb89-33e2567a687e\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTnbAZtvoEOe\",\"invoice_prefix\":\"01006C8E\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTnbAZtvoEOe/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTnbAZtvoEOe/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTnbAZtvoEOe/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"b457a533-2d8b-4e98-9531-e1cc78861d4c\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=386052735
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53196" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"b457a533-2d8b-4e98-9531-e1cc78861d4c\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=b457a533-2d8b-4e98-9531-e1cc78861d4c role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:27:53 http: panic serving 172.26.0.3:53196: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 333 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00041a280)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc000158380, 0xc0002d8800)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc000158380, 0xc0002d8800)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc000158380, 0xc0002d8600)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc000158380, 0xc0002d8500)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc000158380, 0xc0002d8400)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc000158380, 0xc0002d8400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc000158380, 0xc0002d8200)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc000158380, 0xc0002d8200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc000158380, 0xc0002d8200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00041a280, 0x908440, 0xc000096140)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53436" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"b457a533-2d8b-4e98-9531-e1cc78861d4c\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=b457a533-2d8b-4e98-9531-e1cc78861d4c role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:27:53 http: panic serving 172.26.0.3:53436: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 431 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc000198be0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e000, 0xc00014ab00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e000, 0xc00014ab00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e000, 0xc00014aa00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e000, 0xc00014a900)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e000, 0xc00014a800)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e000, 0xc00014a800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e000, 0xc00014a600)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e000, 0xc00014a600)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e000, 0xc00014a600)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc000198be0, 0x908440, 0xc000068480)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53438" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_2e7b3c97-5c64-4819-bf06-710697b48f4e\",\"id_plan\":\"basic_trial\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=info msg="Request completed in 265.506657ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWKZFqtLrMpqCWyrPVJb5e
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"24e76276-ab6d-4cd1-9f5c-0f3f2fc512f6\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=info msg="Request completed in 363.141197ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_2e7b3c97-5c64-4819-bf06-710697b48f4e CUSTOMER_ID=cus_L1ZTN2nOWyluP6 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045274,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_2e7b3c97-5c64-4819-bf06-710697b48f4e\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZTN2nOWyluP6\",\"invoice_prefix\":\"16214A40\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTN2nOWyluP6/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTN2nOWyluP6/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZTN2nOWyluP6/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"02996450-86a2-4eb1-bb8b-eda3561fe516\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=379708617
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53438" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"02996450-86a2-4eb1-bb8b-eda3561fe516\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=02996450-86a2-4eb1-bb8b-eda3561fe516 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:27:54 http: panic serving 172.26.0.3:53438: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 444 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00041a3c0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e700, 0xc00014be00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e700, 0xc00014be00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e700, 0xc00014bd00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e700, 0xc00014b800)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e700, 0xc00014b700)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e700, 0xc00014b700)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e700, 0xc00014b500)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e700, 0xc00014b500)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e700, 0xc00014b500)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00041a3c0, 0x908440, 0xc0003f4600)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:53450" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"02996450-86a2-4eb1-bb8b-eda3561fe516\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=02996450-86a2-4eb1-bb8b-eda3561fe516 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:27:54 http: panic serving 172.26.0.3:53450: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 447 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00041b040)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e9a0, 0xc0001ec300)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e9a0, 0xc0001ec300)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e9a0, 0xc0001ec200)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e9a0, 0xc0001ec100)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e9a0, 0xc0001ec000)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e9a0, 0xc0001ec000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e9a0, 0xc00019e400)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e9a0, 0xc00019e400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e9a0, 0xc00019e400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00041b040, 0x908440, 0xc0003f52c0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:27:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:54006" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_9522f7e4-eb30-4c50-b729-4f377edf70d8\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:18Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=info msg="Request completed in 992.444179ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_9522f7e4-eb30-4c50-b729-4f377edf70d8 CUSTOMER_ID=cus_L1ZULx1BjodwKS STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045359,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_9522f7e4-eb30-4c50-b729-4f377edf70d8\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZULx1BjodwKS\",\"invoice_prefix\":\"6C78645D\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZULx1BjodwKS/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZULx1BjodwKS/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZULx1BjodwKS/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"cd4afd72-67f0-415b-b8ed-a3cca2677623\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:19Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1026652117
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:20Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:20Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:20Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:29:20Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:54306" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"cd4afd72-67f0-415b-b8ed-a3cca2677623\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWMPFqtLrMpqCW2VQjJJIC\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=cd4afd72-67f0-415b-b8ed-a3cca2677623 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:02Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWMPFqtLrMpqCW2VQjJJIC/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:03Z" level=info msg="Request completed in 871.136668ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:03Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZULx1BjodwKS STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643045386,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZULx1BjodwKS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWMPFqtLrMpqCW2VQjJJIC\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:03Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZULx1BjodwKS\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:03Z" level=info msg="Request completed in 416.032398ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:03Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZULx1BjodwKS STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643045359,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_9522f7e4-eb30-4c50-b729-4f377edf70d8\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZULx1BjodwKS\",\"invoice_prefix\":\"6C78645D\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWMPFqtLrMpqCW2VQjJJIC\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZULx1BjodwKS/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZULx1BjodwKS/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZULx1BjodwKS/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:03Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:05Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=info msg="Request completed in 2.354638154s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZULx1BjodwKS STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643045404,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643045404,\"current_period_end\":1645723804,\"current_period_start\":1643045404,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZULx1BjodwKS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWMiFqtLrMpqCW9dXY2GJ2\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWMiFqtLrMpqCW9dXY2GJ2\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643045404,\"deleted\":false,\"id\":\"si_L1ZVZzxIc2UNn0\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWMiFqtLrMpqCW9dXY2GJ2\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643045404,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZULx1BjodwKS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpWNlF4ZVlDYU44blEzYVZWOFRtdUEyTmhoWlgw01006LCWNV6j\",\"id\":\"in_1KLWMiFqtLrMpqCWyMYiA4zF\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpWNlF4ZVlDYU44blEzYVZWOFRtdUEyTmhoWlgw01006LCWNV6j/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWMiFqtLrMpqCWyMYiA4zF/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWMiFqtLrMpqCWipr069GV\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645723804,\"start\":1643045404},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWMiFqtLrMpqCW9dXY2GJ2\",\"subscription_item\":\"si_L1ZVZzxIc2UNn0\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"6C78645D-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWMiFqtLrMpqCW0YvUaigb\",\"data\":[]},\"client_secret\":\"pi_3KLWMiFqtLrMpqCW0YvUaigb_secret_KA4Au5IKYe4uNpUYxBpxRTl3i\",\"confirmation_method\":\"automatic\",\"created\":1643045404,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZULx1BjodwKS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWMiFqtLrMpqCWyMYiA4zF\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWMiFqtLrMpqCW0YvUaigb\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWMPFqtLrMpqCW2VQjJJIC\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643045404,\"period_start\":1643045404,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643045404,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWMiFqtLrMpqCW9dXY2GJ2\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643045404,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWMiFqtLrMpqCW9dXY2GJ2
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"cd4afd72-67f0-415b-b8ed-a3cca2677623\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"cd4afd72-67f0-415b-b8ed-a3cca2677623\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3671860972
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWMiFqtLrMpqCW9dXY2GJ2
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWMiFqtLrMpqCW9dXY2GJ2
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWMiFqtLrMpqCW9dXY2GJ2\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=info msg="Request completed in 279.291663ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWMiFqtLrMpqCW9dXY2GJ2
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"cd4afd72-67f0-415b-b8ed-a3cca2677623\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:06Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:30:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_795f5635-ebaf-4805-81e1-c1dc618684f9\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:15Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=info msg="Request completed in 1.267325506s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_795f5635-ebaf-4805-81e1-c1dc618684f9 CUSTOMER_ID=cus_L1ZoFBEIyfty7G STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046556,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_795f5635-ebaf-4805-81e1-c1dc618684f9\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"441C092D\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZoFBEIyfty7G/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZoFBEIyfty7G/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZoFBEIyfty7G/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ddd77ad8-5507-4612-9a9a-40065c027433\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:16Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1293746080
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:17Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:17Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:17Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ddd77ad8-5507-4612-9a9a-40065c027433\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfJFqtLrMpqCWetfm3VcF\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ddd77ad8-5507-4612-9a9a-40065c027433 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfJFqtLrMpqCWetfm3VcF/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=info msg="Request completed in 785.860487ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZoFBEIyfty7G STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046558,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfJFqtLrMpqCWetfm3VcF\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:18Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZoFBEIyfty7G\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=info msg="Request completed in 392.698178ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZoFBEIyfty7G STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046556,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_795f5635-ebaf-4805-81e1-c1dc618684f9\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"441C092D\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfJFqtLrMpqCWetfm3VcF\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZoFBEIyfty7G/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZoFBEIyfty7G/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZoFBEIyfty7G/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:19Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=info msg="Request completed in 2.920110507s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZoFBEIyfty7G STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046559,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046559,\"current_period_end\":1645724959,\"current_period_start\":1643046559,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfLFqtLrMpqCWHXMqejSE\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfLFqtLrMpqCWHXMqejSE\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046560,\"deleted\":false,\"id\":\"si_L1Zosc0FjPEJ06\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfLFqtLrMpqCWHXMqejSE\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWfMFqtLrMpqCW0xvbU4n6\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643046559,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwMTd4dkQwOXU4MHhndmpIZGxUUmtraUV3TVBI0100GHNuXYib\",\"id\":\"in_1KLWfLFqtLrMpqCWeSi7YFGD\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwMTd4dkQwOXU4MHhndmpIZGxUUmtraUV3TVBI0100GHNuXYib/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfLFqtLrMpqCWeSi7YFGD/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfLFqtLrMpqCWvPUZNRvJ\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724959,\"start\":1643046559},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfLFqtLrMpqCWHXMqejSE\",\"subscription_item\":\"si_L1Zosc0FjPEJ06\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"441C092D-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWfMFqtLrMpqCW0mz2HbcH\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWfMFqtLrMpqCW0VPyANhq\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643046560,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWfMFqtLrMpqCW0xvbU4n6\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfLFqtLrMpqCWeSi7YFGD\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":42,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWfMFqtLrMpqCW0mz2HbcH\",\"payment_method\":\"pm_1KLWfJFqtLrMpqCWetfm3VcF\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWfMFqtLrMpqCW0xvbU4n6/rcpt_L1ZptpWE161L6Mz1rgB3vRvkB6eNou5\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWfMFqtLrMpqCW0xvbU4n6/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWfMFqtLrMpqCW0mz2HbcH_secret_WbY64K7gx0EZUsMafJLwBEJ0k\",\"confirmation_method\":\"automatic\",\"created\":1643046560,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZoFBEIyfty7G\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfLFqtLrMpqCWeSi7YFGD\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfMFqtLrMpqCW0mz2HbcH\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfJFqtLrMpqCWetfm3VcF\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046559,\"period_start\":1643046559,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643046559,\"marked_uncollectible_at\":0,\"paid_at\":1643046559,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfLFqtLrMpqCWHXMqejSE\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046559,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWfLFqtLrMpqCWHXMqejSE
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"ddd77ad8-5507-4612-9a9a-40065c027433\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ddd77ad8-5507-4612-9a9a-40065c027433\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4121183530
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_3db65cd0-6695-41d0-bdc1-34a45ba9293b\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=info msg="Request completed in 448.275567ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_3db65cd0-6695-41d0-bdc1-34a45ba9293b CUSTOMER_ID=cus_L1ZpgYUIgxgmew STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046562,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_3db65cd0-6695-41d0-bdc1-34a45ba9293b\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpgYUIgxgmew\",\"invoice_prefix\":\"D3063C46\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpgYUIgxgmew/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpgYUIgxgmew/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpgYUIgxgmew/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7fdedb02-ec4f-48e1-a489-dfb779f114fe\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:22Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=474499197
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7fdedb02-ec4f-48e1-a489-dfb779f114fe\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfOFqtLrMpqCW43AKlE6P\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7fdedb02-ec4f-48e1-a489-dfb779f114fe role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:23Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfOFqtLrMpqCW43AKlE6P/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:24Z" level=info msg="Request completed in 810.632559ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:24Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZpgYUIgxgmew STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046563,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpgYUIgxgmew\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfOFqtLrMpqCW43AKlE6P\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:24Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZpgYUIgxgmew\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:24Z" level=info msg="Request completed in 412.585732ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:24Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZpgYUIgxgmew STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046562,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_3db65cd0-6695-41d0-bdc1-34a45ba9293b\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpgYUIgxgmew\",\"invoice_prefix\":\"D3063C46\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfOFqtLrMpqCW43AKlE6P\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpgYUIgxgmew/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpgYUIgxgmew/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpgYUIgxgmew/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:24Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:25Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=info msg="Request completed in 2.281855832s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZpgYUIgxgmew STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046564,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046564,\"current_period_end\":1645724964,\"current_period_start\":1643046564,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpgYUIgxgmew\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfQFqtLrMpqCWf34JOoQD\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfQFqtLrMpqCWf34JOoQD\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046565,\"deleted\":false,\"id\":\"si_L1ZpmuLR6qSmrb\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfQFqtLrMpqCWf34JOoQD\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643046564,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpgYUIgxgmew\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwRm1adGplZ0JCS1RPNjIyZnNkcVVkSUJwcWxF0100HCGlihgS\",\"id\":\"in_1KLWfQFqtLrMpqCWrYd39l0k\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwRm1adGplZ0JCS1RPNjIyZnNkcVVkSUJwcWxF0100HCGlihgS/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfQFqtLrMpqCWrYd39l0k/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfQFqtLrMpqCWpXURGfYq\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724964,\"start\":1643046564},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfQFqtLrMpqCWf34JOoQD\",\"subscription_item\":\"si_L1ZpmuLR6qSmrb\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D3063C46-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWfRFqtLrMpqCW1TFls8Gh\",\"data\":[]},\"client_secret\":\"pi_3KLWfRFqtLrMpqCW1TFls8Gh_secret_8cNObBwPSkZoE2CQWiuovqk5Z\",\"confirmation_method\":\"automatic\",\"created\":1643046565,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpgYUIgxgmew\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfQFqtLrMpqCWrYd39l0k\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfRFqtLrMpqCW1TFls8Gh\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfOFqtLrMpqCW43AKlE6P\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046564,\"period_start\":1643046564,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643046564,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfQFqtLrMpqCWf34JOoQD\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046564,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWfQFqtLrMpqCWf34JOoQD
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7fdedb02-ec4f-48e1-a489-dfb779f114fe\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7fdedb02-ec4f-48e1-a489-dfb779f114fe\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3538971933
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_af601b38-484c-49ba-9e87-9b428dd754aa\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:26Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWfQFqtLrMpqCWf34JOoQD
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWfQFqtLrMpqCWf34JOoQD
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWfQFqtLrMpqCWf34JOoQD\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=info msg="Request completed in 401.577005ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_af601b38-484c-49ba-9e87-9b428dd754aa CUSTOMER_ID=cus_L1ZpJilZ2zmve8 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046567,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_af601b38-484c-49ba-9e87-9b428dd754aa\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"8A251972\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=424304034
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfTFqtLrMpqCWpm7ooFe0\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=9981168b-28ab-490b-ab5a-a696d97f1cb6 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfTFqtLrMpqCWpm7ooFe0/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=info msg="Request completed in 839.958807ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWfQFqtLrMpqCWf34JOoQD
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7fdedb02-ec4f-48e1-a489-dfb779f114fe\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=info msg="Request completed in 796.467967ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046567,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfTFqtLrMpqCWpm7ooFe0\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZpJilZ2zmve8\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:28Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=info msg="Request completed in 411.519093ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046567,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_af601b38-484c-49ba-9e87-9b428dd754aa\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"8A251972\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfTFqtLrMpqCWpm7ooFe0\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=info msg="Request completed in 2.150647412s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046569,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"current_period_end\":1645724969,\"current_period_start\":1643046569,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046569,\"deleted\":false,\"id\":\"si_L1ZppnPffGVui7\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfVFqtLrMpqCWEzQmp0rx/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfVFqtLrMpqCWCQbhTp0N\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724969,\"start\":1643046569},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"subscription_item\":\"si_L1ZppnPffGVui7\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"8A251972-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWfVFqtLrMpqCW1SJeDPKp\",\"data\":[]},\"client_secret\":\"pi_3KLWfVFqtLrMpqCW1SJeDPKp_secret_llS4hs1qNjTThmDrixFPoCsjY\",\"confirmation_method\":\"automatic\",\"created\":1643046569,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfVFqtLrMpqCW1SJeDPKp\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfTFqtLrMpqCWpm7ooFe0\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046569,\"period_start\":1643046569,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643046569,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046569,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWfVFqtLrMpqCWcAwlewrg
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3379332967
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWfVFqtLrMpqCWcAwlewrg
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWfVFqtLrMpqCWcAwlewrg
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWfVFqtLrMpqCWcAwlewrg\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=info msg="Request completed in 276.389914ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWfVFqtLrMpqCWcAwlewrg
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/retry
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="retry subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:42"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfXFqtLrMpqCWhJoeIeBF\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:50"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=9981168b-28ab-490b-ab5a-a696d97f1cb6 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:57"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZpJilZ2zmve8\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="executing paymentId change on the provider" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:64"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=info msg="Requesting GET api.stripe.com/v1/invoices\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:31Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=info msg="Request completed in 285.978479ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="retrieved invoice" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:119" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 INVOICE_ID=in_1KLWfVFqtLrMpqCWEzQmp0rx STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfVFqtLrMpqCWEzQmp0rx/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfVFqtLrMpqCWCQbhTp0N\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724969,\"start\":1643046569},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"subscription_item\":\"si_L1ZppnPffGVui7\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"8A251972-0001\",\"paid\":false,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfVFqtLrMpqCW1SJeDPKp\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046569,\"period_start\":1643046569,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643046569,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfXFqtLrMpqCWhJoeIeBF/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=info msg="Request completed in 764.652046ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:136" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 INVOICE_ID=in_1KLWfVFqtLrMpqCWEzQmp0rx STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046571,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfXFqtLrMpqCWhJoeIeBF\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:32Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZpJilZ2zmve8\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=info msg="Request completed in 446.606408ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:155" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 INVOICE_ID=in_1KLWfVFqtLrMpqCWEzQmp0rx STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046567,\"currency\":\"eur\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_af601b38-484c-49ba-9e87-9b428dd754aa\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"8A251972\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfXFqtLrMpqCWhJoeIeBF\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":2,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/subscriptions\",\"data\":[{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046569,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"current_period_end\":1645724969,\"current_period_start\":1643046569,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046569,\"deleted\":false,\"id\":\"si_L1ZppnPffGVui7\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046569,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpJilZ2zmve8/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=info msg="Requesting GET api.stripe.com/v1/invoices/in_1KLWfVFqtLrMpqCWEzQmp0rx\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=info msg="Request completed in 391.161484ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=debug msg="invoice id updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:172" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 INVOICE_ID=in_1KLWfVFqtLrMpqCWEzQmp0rx STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfVFqtLrMpqCWEzQmp0rx/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfVFqtLrMpqCWCQbhTp0N\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724969,\"start\":1643046569},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"subscription_item\":\"si_L1ZppnPffGVui7\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"8A251972-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWfVFqtLrMpqCW1SJeDPKp\",\"data\":[]},\"client_secret\":\"pi_3KLWfVFqtLrMpqCW1SJeDPKp_secret_llS4hs1qNjTThmDrixFPoCsjY\",\"confirmation_method\":\"automatic\",\"created\":1643046569,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfVFqtLrMpqCW1SJeDPKp\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfTFqtLrMpqCWpm7ooFe0\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046569,\"period_start\":1643046569,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643046569,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643046572,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:33Z" level=info msg="Requesting POST api.stripe.com/v1/invoices/in_1KLWfVFqtLrMpqCWEzQmp0rx/pay\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="Request completed in 2.334705318s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="invoice paid" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:187" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 INVOICE_ID=in_1KLWfVFqtLrMpqCWEzQmp0rx STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWfVFqtLrMpqCW1ImAw8mN\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwTVZaUDlqS043Z01qMU5DVmsyWDhUQzlqcWow0100EDe8ITvA/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfVFqtLrMpqCWEzQmp0rx/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfVFqtLrMpqCWCQbhTp0N\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724969,\"start\":1643046569},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"subscription_item\":\"si_L1ZppnPffGVui7\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"8A251972-0001\",\"paid\":true,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfVFqtLrMpqCW1SJeDPKp\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046569,\"period_start\":1643046569,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643046569,\"marked_uncollectible_at\":0,\"paid_at\":1643046573,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643046572,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWfVFqtLrMpqCWcAwlewrg\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="Request completed in 277.897019ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="subscription found" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:200" CUSTOMER_ID=cus_L1ZpJilZ2zmve8 INVOICE_ID=in_1KLWfVFqtLrMpqCWEzQmp0rx STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046569,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046569,\"current_period_end\":1645724969,\"current_period_start\":1643046569,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpJilZ2zmve8\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046569,\"deleted\":false,\"id\":\"si_L1ZppnPffGVui7\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfVFqtLrMpqCWcAwlewrg\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfVFqtLrMpqCWEzQmp0rx\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046569,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWfVFqtLrMpqCWcAwlewrg
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="update subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:74"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"9981168b-28ab-490b-ab5a-a696d97f1cb6\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="subscription retry done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:98" ACCOUNT_ID=9981168b-28ab-490b-ab5a-a696d97f1cb6 CUSTOMER_ID=cus_L1ZpJilZ2zmve8 PLAN_ID=price_1IMKMvFqtLrMpqCW3mMM3mDS SUBSCRIPTION_ID=sub_1KLWfVFqtLrMpqCWcAwlewrg
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4534595906
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_61dc72c9-fca3-48b1-940e-d8cbd9174b65\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="Request completed in 380.590725ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_61dc72c9-fca3-48b1-940e-d8cbd9174b65 CUSTOMER_ID=cus_L1ZpsX8HwC8EYL STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046576,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_61dc72c9-fca3-48b1-940e-d8cbd9174b65\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"4727C91B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpsX8HwC8EYL/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpsX8HwC8EYL/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpsX8HwC8EYL/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=405082487
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:36Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfcFqtLrMpqCWXNsNF2cV\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:37Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfcFqtLrMpqCWXNsNF2cV/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=info msg="Request completed in 956.329921ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZpsX8HwC8EYL STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046577,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfcFqtLrMpqCWXNsNF2cV\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZpsX8HwC8EYL\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=info msg="Request completed in 427.64388ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZpsX8HwC8EYL STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046576,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_61dc72c9-fca3-48b1-940e-d8cbd9174b65\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"4727C91B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfcFqtLrMpqCWXNsNF2cV\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpsX8HwC8EYL/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpsX8HwC8EYL/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpsX8HwC8EYL/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:38Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=info msg="Request completed in 3.42510083s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZpsX8HwC8EYL STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046578,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046578,\"current_period_end\":1645724978,\"current_period_start\":1643046578,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWffFqtLrMpqCWwxFTMJxJ\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWffFqtLrMpqCWwxFTMJxJ\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046579,\"deleted\":false,\"id\":\"si_L1Zpz7Msh2TiH1\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWffFqtLrMpqCWwxFTMJxJ\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWffFqtLrMpqCW06VheWrD\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643046579,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwWVMzNDRuZDZwQldSbjdsNDBBRnJwZ09QQzU20100FCy1ZeUS\",\"id\":\"in_1KLWffFqtLrMpqCWUzXL2GSq\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwWVMzNDRuZDZwQldSbjdsNDBBRnJwZ09QQzU20100FCy1ZeUS/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWffFqtLrMpqCWUzXL2GSq/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWffFqtLrMpqCWbnS53xzV\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724978,\"start\":1643046578},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWffFqtLrMpqCWwxFTMJxJ\",\"subscription_item\":\"si_L1Zpz7Msh2TiH1\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"4727C91B-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWffFqtLrMpqCW0KLXefL7\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWffFqtLrMpqCW07NTJvSo\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643046580,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWffFqtLrMpqCW06VheWrD\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWffFqtLrMpqCWUzXL2GSq\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":55,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWffFqtLrMpqCW0KLXefL7\",\"payment_method\":\"pm_1KLWfcFqtLrMpqCWXNsNF2cV\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWffFqtLrMpqCW06VheWrD/rcpt_L1ZpRA27GJYzsVTVaFSPHsC7atY1l2U\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWffFqtLrMpqCW06VheWrD/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWffFqtLrMpqCW0KLXefL7_secret_rQzjGGjFS0o564LCxYUBrOb2C\",\"confirmation_method\":\"automatic\",\"created\":1643046579,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpsX8HwC8EYL\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWffFqtLrMpqCWUzXL2GSq\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWffFqtLrMpqCW0KLXefL7\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfcFqtLrMpqCWXNsNF2cV\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046578,\"period_start\":1643046578,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643046578,\"marked_uncollectible_at\":0,\"paid_at\":1643046578,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWffFqtLrMpqCWwxFTMJxJ\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046578,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWffFqtLrMpqCWwxFTMJxJ
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4842157010
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/change
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="change subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:52"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"id_plan\":\"premium\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="get stripe plan id" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func2" file="/app/pkg/subscription/handle_change.go:94"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:66"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="GetStripePlanFromPlanID result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripePlanFromPlan file="/app/pkg/subscription/handle_utils.go:31" HASURA_RESPONSE="{\"subscription_plan\":[{\"stripe_code\":\"price_1IMKNbFqtLrMpqCWztWScMzg\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1ZpsX8HwC8EYL\"},\"subscription_status\":{\"status\":\"active\",\"stripe_subscription_id\":\"sub_1KLWffFqtLrMpqCWwxFTMJxJ\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="update subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:115"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="getting subscription information from stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:155"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWffFqtLrMpqCWwxFTMJxJ\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=info msg="Request completed in 275.597701ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="updating subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:162"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions/sub_1KLWffFqtLrMpqCWwxFTMJxJ\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=info msg="Request completed in 1.670087605s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:122"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"premium\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"id_plan\":\"premium\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:129"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=info msg="subscription change done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:146" ACCOUNT_ID=7816e1c4-ebed-4cbb-bdf4-fd9d47bda4da CUSTOMER_ID=cus_L1ZpsX8HwC8EYL PLAN_ID=price_1IMKNbFqtLrMpqCWztWScMzg SUBSCRIPTION_ID=sub_1KLWffFqtLrMpqCWwxFTMJxJ
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1973841041
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_6cbcdae2-5744-42ff-b3c8-5abba78e1087\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=info msg="Request completed in 431.171803ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_6cbcdae2-5744-42ff-b3c8-5abba78e1087 CUSTOMER_ID=cus_L1ZpdjQ1hU28OI STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046584,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_6cbcdae2-5744-42ff-b3c8-5abba78e1087\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"9EB25FA4\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpdjQ1hU28OI/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpdjQ1hU28OI/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpdjQ1hU28OI/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"b76d8dba-b4da-43f7-812c-6465c5b66783\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=456573371
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:44Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"b76d8dba-b4da-43f7-812c-6465c5b66783\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfkFqtLrMpqCWtTrAg49Y\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=b76d8dba-b4da-43f7-812c-6465c5b66783 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:45Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfkFqtLrMpqCWtTrAg49Y/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=info msg="Request completed in 814.593028ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1ZpdjQ1hU28OI STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046585,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfkFqtLrMpqCWtTrAg49Y\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1ZpdjQ1hU28OI\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=info msg="Request completed in 412.161238ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1ZpdjQ1hU28OI STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046584,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_6cbcdae2-5744-42ff-b3c8-5abba78e1087\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"9EB25FA4\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfkFqtLrMpqCWtTrAg49Y\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpdjQ1hU28OI/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpdjQ1hU28OI/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpdjQ1hU28OI/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:46Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=info msg="Request completed in 3.012444649s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1ZpdjQ1hU28OI STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046586,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046586,\"current_period_end\":1645724986,\"current_period_start\":1643046586,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046587,\"deleted\":false,\"id\":\"si_L1Zpi3W15oi7KY\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWfnFqtLrMpqCW1HkMCLRw\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643046586,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwZXA0UnhXbUw0ZGtRUGgxMUk2Umt5Rk1YdEQ00100J42Dbcyh\",\"id\":\"in_1KLWfmFqtLrMpqCWuVWArMhP\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwZXA0UnhXbUw0ZGtRUGgxMUk2Umt5Rk1YdEQ00100J42Dbcyh/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWfmFqtLrMpqCWuVWArMhP/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWfmFqtLrMpqCW0Rp4Tpfr\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724986,\"start\":1643046586},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"subscription_item\":\"si_L1Zpi3W15oi7KY\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"9EB25FA4-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWfnFqtLrMpqCW1NblhJAy\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWfnFqtLrMpqCW1ZmS0Izh\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643046587,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWfnFqtLrMpqCW1HkMCLRw\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfmFqtLrMpqCWuVWArMhP\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":51,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWfnFqtLrMpqCW1NblhJAy\",\"payment_method\":\"pm_1KLWfkFqtLrMpqCWtTrAg49Y\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWfnFqtLrMpqCW1HkMCLRw/rcpt_L1ZpjobGVDn7TXHFgtswhZrmkVPqFfJ\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWfnFqtLrMpqCW1HkMCLRw/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWfnFqtLrMpqCW1NblhJAy_secret_DNFkuusXVL2zdTpmYelOwhax2\",\"confirmation_method\":\"automatic\",\"created\":1643046587,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfmFqtLrMpqCWuVWArMhP\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfnFqtLrMpqCW1NblhJAy\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfkFqtLrMpqCWtTrAg49Y\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046586,\"period_start\":1643046586,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643046586,\"marked_uncollectible_at\":0,\"paid_at\":1643046586,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046586,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWfmFqtLrMpqCWBSGTWNjc
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"b76d8dba-b4da-43f7-812c-6465c5b66783\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"b76d8dba-b4da-43f7-812c-6465c5b66783\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4272415297
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/cancel
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="cancel subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:36"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"b76d8dba-b4da-43f7-812c-6465c5b66783\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:44"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=b76d8dba-b4da-43f7-812c-6465c5b66783 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="retrieving subscription id on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:51"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="GetStripeSubscription result" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).getStripeSubscriptionID" file="/app/pkg/subscription/handle_cancel.go:99" HASURA_RESPONSE="{\"subscription_status\":[{\"stripe_subscription_id\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="cancelling stripe subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:58"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=info msg="Requesting DELETE api.stripe.com/v1/subscriptions/sub_1KLWfmFqtLrMpqCWBSGTWNjc\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:49Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:50Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=info msg="Request completed in 1.51181404s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).cancelStripeSubscription" file="/app/pkg/subscription/handle_cancel.go:120" ACCOUNT_ID=b76d8dba-b4da-43f7-812c-6465c5b66783 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046586,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":1643046590,\"collection_method\":\"charge_automatically\",\"created\":1643046586,\"current_period_end\":1645724986,\"current_period_start\":1643046586,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpdjQ1hU28OI\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":1643046590,\"id\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046587,\"deleted\":false,\"id\":\"si_L1Zpi3W15oi7KY\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWfmFqtLrMpqCWBSGTWNjc\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWfmFqtLrMpqCWuVWArMhP\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046586,\"status\":\"canceled\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWfmFqtLrMpqCWBSGTWNjc
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="updating hasura with the cancellation status" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:65"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"b76d8dba-b4da-43f7-812c-6465c5b66783\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"canceled\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:72"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"status\":\"canceled\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1531402030
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_09584d9b-5d09-4e66-8fe7-cf7c1e74d3a7\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.deleted
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.deleted
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=info msg="Request completed in 415.742069ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_09584d9b-5d09-4e66-8fe7-cf7c1e74d3a7 CUSTOMER_ID=cus_L1Zp9BY5ywlGkW STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046591,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_09584d9b-5d09-4e66-8fe7-cf7c1e74d3a7\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"A1A678BB\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1Zp9BY5ywlGkW/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1Zp9BY5ywlGkW/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1Zp9BY5ywlGkW/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"2e7c0713-4cea-4fef-8e65-3f5f9820cbe2\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=443614837
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:51Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"2e7c0713-4cea-4fef-8e65-3f5f9820cbe2\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWfrFqtLrMpqCWW1Blsh3f\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=2e7c0713-4cea-4fef-8e65-3f5f9820cbe2 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWfrFqtLrMpqCWW1Blsh3f/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=info msg="Request completed in 840.111554ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1Zp9BY5ywlGkW STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643046591,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWfrFqtLrMpqCWW1Blsh3f\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:52Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1Zp9BY5ywlGkW\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=info msg="Request completed in 447.216513ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1Zp9BY5ywlGkW STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046591,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_09584d9b-5d09-4e66-8fe7-cf7c1e74d3a7\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"A1A678BB\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfrFqtLrMpqCWW1Blsh3f\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1Zp9BY5ywlGkW/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1Zp9BY5ywlGkW/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1Zp9BY5ywlGkW/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=info msg="Request completed in 3.437701136s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1Zp9BY5ywlGkW STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643046593,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643046593,\"current_period_end\":1645724993,\"current_period_start\":1643046593,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWftFqtLrMpqCWlw4mCc6l\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWftFqtLrMpqCWlw4mCc6l\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643046594,\"deleted\":false,\"id\":\"si_L1ZpaZcwDdwY1f\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWftFqtLrMpqCWlw4mCc6l\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWfuFqtLrMpqCW1vgF44Lp\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643046593,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwQ1lUVG5TVk1GSnNzblB3bXVqTUtXem4wNUE40100rtBrBFHP\",\"id\":\"in_1KLWftFqtLrMpqCWXTWmtF1y\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMVpwQ1lUVG5TVk1GSnNzblB3bXVqTUtXem4wNUE40100rtBrBFHP/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWftFqtLrMpqCWXTWmtF1y/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWftFqtLrMpqCWT6AkkbvI\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645724993,\"start\":1643046593},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWftFqtLrMpqCWlw4mCc6l\",\"subscription_item\":\"si_L1ZpaZcwDdwY1f\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"A1A678BB-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWfuFqtLrMpqCW15dAkBJ6\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWfuFqtLrMpqCW12rYVhnw\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643046595,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWfuFqtLrMpqCW1vgF44Lp\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWftFqtLrMpqCWXTWmtF1y\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":9,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWfuFqtLrMpqCW15dAkBJ6\",\"payment_method\":\"pm_1KLWfrFqtLrMpqCWW1Blsh3f\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWfuFqtLrMpqCW1vgF44Lp/rcpt_L1ZpkGApzDvxdOh48s6AmFIdpwDONGp\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWfuFqtLrMpqCW1vgF44Lp/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWfuFqtLrMpqCW15dAkBJ6_secret_5pSxRtUJFqWdyOieBciMOW71G\",\"confirmation_method\":\"automatic\",\"created\":1643046594,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1Zp9BY5ywlGkW\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWftFqtLrMpqCWXTWmtF1y\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWfuFqtLrMpqCW15dAkBJ6\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWfrFqtLrMpqCWW1Blsh3f\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643046593,\"period_start\":1643046593,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643046593,\"marked_uncollectible_at\":0,\"paid_at\":1643046593,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWftFqtLrMpqCWlw4mCc6l\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643046593,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWftFqtLrMpqCWlw4mCc6l
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"2e7c0713-4cea-4fef-8e65-3f5f9820cbe2\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"2e7c0713-4cea-4fef-8e65-3f5f9820cbe2\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4750514013
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_c30914c1-9aaa-45ed-a10c-ca1e3263d644\",\"id_plan\":\"free\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=info msg="Request completed in 408.615256ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_c30914c1-9aaa-45ed-a10c-ca1e3263d644 CUSTOMER_ID=cus_L1ZpPbS6Naw5ec STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046596,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_c30914c1-9aaa-45ed-a10c-ca1e3263d644\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpPbS6Naw5ec\",\"invoice_prefix\":\"3A813CEA\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpPbS6Naw5ec/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpPbS6Naw5ec/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpPbS6Naw5ec/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"d24b6753-d6ed-4dc9-b34b-2366a8958a6e\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=432835969
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33664" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"d24b6753-d6ed-4dc9-b34b-2366a8958a6e\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=d24b6753-d6ed-4dc9-b34b-2366a8958a6e role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:49:57 http: panic serving 172.26.0.3:33664: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 458 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00045c000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0004401c0, 0xc0003b0d00)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0004401c0, 0xc0003b0d00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0004401c0, 0xc0003b0c00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0004401c0, 0xc0003b0b00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0004401c0, 0xc0003b0a00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0004401c0, 0xc0003b0a00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0004401c0, 0xc0003b0800)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0004401c0, 0xc0003b0800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0004401c0, 0xc0003b0800)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00045c000, 0x908440, 0xc000096000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33960" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"d24b6753-d6ed-4dc9-b34b-2366a8958a6e\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=d24b6753-d6ed-4dc9-b34b-2366a8958a6e role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:49:57 http: panic serving 172.26.0.3:33960: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 649 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc000199860)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc000440460, 0xc0003b1300)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc000440460, 0xc0003b1300)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc000440460, 0xc0003b1200)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc000440460, 0xc0003b1100)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc000440460, 0xc0003b1000)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc000440460, 0xc0003b1000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc000440460, 0xc0003b0e00)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc000440460, 0xc0003b0e00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc000440460, 0xc0003b0e00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc000199860, 0x908440, 0xc000212b80)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33962" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_fe492d99-f4b4-4850-8705-8d7693770b86\",\"id_plan\":\"basic_trial\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=info msg="Request completed in 404.064813ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_fe492d99-f4b4-4850-8705-8d7693770b86 CUSTOMER_ID=cus_L1ZpPlF5YZkaCR STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643046597,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_fe492d99-f4b4-4850-8705-8d7693770b86\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1ZpPlF5YZkaCR\",\"invoice_prefix\":\"F536C440\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpPlF5YZkaCR/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpPlF5YZkaCR/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1ZpPlF5YZkaCR/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"6426c49d-7067-47fe-ae8f-369d330235dc\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=431157681
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33962" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"6426c49d-7067-47fe-ae8f-369d330235dc\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=6426c49d-7067-47fe-ae8f-369d330235dc role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:49:57 http: panic serving 172.26.0.3:33962: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 663 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00045cc80)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0002e6000, 0xc0002d8500)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0002e6000, 0xc0002d8500)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0002e6000, 0xc0002d8400)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0002e6000, 0xc0002d8300)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0002e6000, 0xc0002d8200)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0002e6000, 0xc0002d8200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0002e6000, 0xc0002d8000)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0002e6000, 0xc0002d8000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0002e6000, 0xc0002d8000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00045cc80, 0x908440, 0xc000068b00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:33964" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"6426c49d-7067-47fe-ae8f-369d330235dc\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=6426c49d-7067-47fe-ae8f-369d330235dc role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 17:49:57 http: panic serving 172.26.0.3:33964: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 625 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc000199040)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e2a0, 0xc00014b500)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b500)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b400)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b300)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e2a0, 0xc00014b100)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e2a0, 0xc00014b100)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e2a0, 0xc00014af00)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e2a0, 0xc00014af00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e2a0, 0xc00014af00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc000199040, 0x908440, 0xc0003f4580)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:57Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T17:49:58Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_65a19ca6-7e5b-4dff-8341-0a656879d8f5\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:25Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=info msg="Request completed in 1.442025002s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_65a19ca6-7e5b-4dff-8341-0a656879d8f5 CUSTOMER_ID=cus_L1a2CFcRC6FvW9 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047346,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_65a19ca6-7e5b-4dff-8341-0a656879d8f5\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"D3B136F7\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2CFcRC6FvW9/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2CFcRC6FvW9/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2CFcRC6FvW9/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"5d140f40-e905-4226-aae3-e073ad06ab41\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1461547841
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:27Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"5d140f40-e905-4226-aae3-e073ad06ab41\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWs3FqtLrMpqCW3ttH4v07\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=5d140f40-e905-4226-aae3-e073ad06ab41 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:28Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWs3FqtLrMpqCW3ttH4v07/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=info msg="Request completed in 833.275575ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1a2CFcRC6FvW9 STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047348,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWs3FqtLrMpqCW3ttH4v07\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a2CFcRC6FvW9\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=info msg="Request completed in 399.215898ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1a2CFcRC6FvW9 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047346,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_65a19ca6-7e5b-4dff-8341-0a656879d8f5\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"D3B136F7\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWs3FqtLrMpqCW3ttH4v07\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2CFcRC6FvW9/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2CFcRC6FvW9/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2CFcRC6FvW9/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:29Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=info msg="Request completed in 2.843729252s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1a2CFcRC6FvW9 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047349,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047349,\"current_period_end\":1645725749,\"current_period_start\":1643047349,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWs5FqtLrMpqCWrHRffPlt\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWs5FqtLrMpqCWrHRffPlt\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047350,\"deleted\":false,\"id\":\"si_L1a2EVdF0mZleo\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWs5FqtLrMpqCWrHRffPlt\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWs6FqtLrMpqCW0rQK2gjV\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643047349,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyb3N6WXFZWEF5UHlkN0REREdrbWZ3SEVxZjRN01001uiAm1Xm\",\"id\":\"in_1KLWs5FqtLrMpqCWiCmsIMjX\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyb3N6WXFZWEF5UHlkN0REREdrbWZ3SEVxZjRN01001uiAm1Xm/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWs5FqtLrMpqCWiCmsIMjX/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWs5FqtLrMpqCWp0LynJKa\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725749,\"start\":1643047349},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWs5FqtLrMpqCWrHRffPlt\",\"subscription_item\":\"si_L1a2EVdF0mZleo\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"D3B136F7-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWs6FqtLrMpqCW0Iasfict\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWs6FqtLrMpqCW0RfK9WEw\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643047350,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWs6FqtLrMpqCW0rQK2gjV\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWs5FqtLrMpqCWiCmsIMjX\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":24,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWs6FqtLrMpqCW0Iasfict\",\"payment_method\":\"pm_1KLWs3FqtLrMpqCW3ttH4v07\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWs6FqtLrMpqCW0rQK2gjV/rcpt_L1a2cUxXwUnIghAIeyj0HMuPLf5RnV7\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWs6FqtLrMpqCW0rQK2gjV/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWs6FqtLrMpqCW0Iasfict_secret_gAZO0pRjyaKsKPtCVc0yTRQMQ\",\"confirmation_method\":\"automatic\",\"created\":1643047350,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2CFcRC6FvW9\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWs5FqtLrMpqCWiCmsIMjX\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWs6FqtLrMpqCW0Iasfict\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWs3FqtLrMpqCW3ttH4v07\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047349,\"period_start\":1643047349,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643047349,\"marked_uncollectible_at\":0,\"paid_at\":1643047349,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWs5FqtLrMpqCWrHRffPlt\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047349,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWs5FqtLrMpqCWrHRffPlt
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"5d140f40-e905-4226-aae3-e073ad06ab41\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"5d140f40-e905-4226-aae3-e073ad06ab41\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4104292597
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_f9c9e4cd-fbdc-4560-98fb-b0ea5730b236\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=info msg="Request completed in 394.39515ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_f9c9e4cd-fbdc-4560-98fb-b0ea5730b236 CUSTOMER_ID=cus_L1a2t14UZ9edl6 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047352,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_f9c9e4cd-fbdc-4560-98fb-b0ea5730b236\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2t14UZ9edl6\",\"invoice_prefix\":\"01793CE7\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2t14UZ9edl6/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2t14UZ9edl6/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2t14UZ9edl6/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"a3864409-2dc4-438e-87ac-3998d5a5cc03\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=420267180
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:32Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"a3864409-2dc4-438e-87ac-3998d5a5cc03\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWs8FqtLrMpqCWVRMC1NBd\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=a3864409-2dc4-438e-87ac-3998d5a5cc03 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWs8FqtLrMpqCWVRMC1NBd/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:33Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=info msg="Request completed in 810.991393ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1a2t14UZ9edl6 STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047353,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2t14UZ9edl6\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWs8FqtLrMpqCWVRMC1NBd\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a2t14UZ9edl6\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=info msg="Request completed in 392.122902ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1a2t14UZ9edl6 STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047352,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_f9c9e4cd-fbdc-4560-98fb-b0ea5730b236\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2t14UZ9edl6\",\"invoice_prefix\":\"01793CE7\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWs8FqtLrMpqCWVRMC1NBd\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2t14UZ9edl6/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2t14UZ9edl6/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2t14UZ9edl6/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:34Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=info msg="Request completed in 2.631648461s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1a2t14UZ9edl6 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047354,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047354,\"current_period_end\":1645725754,\"current_period_start\":1643047354,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2t14UZ9edl6\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsAFqtLrMpqCWVvCKRk3J\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsAFqtLrMpqCWVvCKRk3J\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047355,\"deleted\":false,\"id\":\"si_L1a26IqqOpUfTM\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsAFqtLrMpqCWVvCKRk3J\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643047354,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2t14UZ9edl6\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyMWFyRXdzUG84ZW9wRDlCb0FRcjFlaG9lYnF50100gNkK1sqN\",\"id\":\"in_1KLWsAFqtLrMpqCWa9zLNsiG\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyMWFyRXdzUG84ZW9wRDlCb0FRcjFlaG9lYnF50100gNkK1sqN/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsAFqtLrMpqCWa9zLNsiG/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsAFqtLrMpqCWILqwkLX2\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725754,\"start\":1643047354},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsAFqtLrMpqCWVvCKRk3J\",\"subscription_item\":\"si_L1a26IqqOpUfTM\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"01793CE7-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWsBFqtLrMpqCW0xfCzKT0\",\"data\":[]},\"client_secret\":\"pi_3KLWsBFqtLrMpqCW0xfCzKT0_secret_vWKscPmaoTnTGWW8Pwu5ca2TK\",\"confirmation_method\":\"automatic\",\"created\":1643047355,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2t14UZ9edl6\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsAFqtLrMpqCWa9zLNsiG\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsBFqtLrMpqCW0xfCzKT0\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWs8FqtLrMpqCWVRMC1NBd\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047354,\"period_start\":1643047354,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643047354,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsAFqtLrMpqCWVvCKRk3J\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047354,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsAFqtLrMpqCWVvCKRk3J
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"a3864409-2dc4-438e-87ac-3998d5a5cc03\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"a3864409-2dc4-438e-87ac-3998d5a5cc03\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3868399606
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_179a2ff8-ee40-416d-9009-48348ff008c3\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWsAFqtLrMpqCWVvCKRk3J
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWsAFqtLrMpqCWVvCKRk3J
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWsAFqtLrMpqCWVvCKRk3J\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=info msg="Request completed in 440.488193ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_179a2ff8-ee40-416d-9009-48348ff008c3 CUSTOMER_ID=cus_L1a2bWjOhaFxMx STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047357,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_179a2ff8-ee40-416d-9009-48348ff008c3\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"A5EE159B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"d51a7a48-1124-47e3-a011-86725d110e49\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=461408324
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=info msg="Request completed in 408.391387ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWsAFqtLrMpqCWVvCKRk3J
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"a3864409-2dc4-438e-87ac-3998d5a5cc03\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:37Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWsDFqtLrMpqCWwgbYRcg9\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=d51a7a48-1124-47e3-a011-86725d110e49 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWsDFqtLrMpqCWwgbYRcg9/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:38Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=info msg="Request completed in 779.927191ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1a2bWjOhaFxMx STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"DE\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"OQZMyCUUG7ZtzkiL\",\"funding\":\"credit\",\"last4\":\"3184\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047358,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWsDFqtLrMpqCWwgbYRcg9\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a2bWjOhaFxMx\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=info msg="Request completed in 452.53789ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1a2bWjOhaFxMx STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047357,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_179a2ff8-ee40-416d-9009-48348ff008c3\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"A5EE159B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsDFqtLrMpqCWwgbYRcg9\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:39Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=info msg="Request completed in 2.241778315s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1a2bWjOhaFxMx STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047359,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"current_period_end\":1645725759,\"current_period_start\":1643047359,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047360,\"deleted\":false,\"id\":\"si_L1a2Xpy5YqX5Xi\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsFFqtLrMpqCWqqIOH5rW/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsFFqtLrMpqCWwZZr4SMB\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725759,\"start\":1643047359},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"subscription_item\":\"si_L1a2Xpy5YqX5Xi\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"A5EE159B-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWsGFqtLrMpqCW0szvObEb\",\"data\":[]},\"client_secret\":\"pi_3KLWsGFqtLrMpqCW0szvObEb_secret_KIk7N76L4vffW4aItOUwYzvTC\",\"confirmation_method\":\"automatic\",\"created\":1643047360,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsGFqtLrMpqCW0szvObEb\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsDFqtLrMpqCWwgbYRcg9\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047359,\"period_start\":1643047359,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643047359,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047359,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsFFqtLrMpqCW2TcpWHPG
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"is_active\":false}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=3505548274
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_failed
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="get account id for subscription" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:20" SUBSCRIPTION_ID=sub_1KLWsFFqtLrMpqCW2TcpWHPG
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=debug msg="get subscription information from invoice" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:32" SUBSCRIPTION_ID=sub_1KLWsFFqtLrMpqCW2TcpWHPG
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:41Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWsFFqtLrMpqCW2TcpWHPG\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_action_required
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=info msg="Request completed in 279.461397ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="update status od the subscription on hasura" func=github.com/ddelizia/hasura-saas/pkg/subscription.ProcessInvoicePaymentFailed file="/app/pkg/subscription/event_invoice_payment_failed.go:41" SUBSCRIPTION_ID=sub_1KLWsFFqtLrMpqCW2TcpWHPG
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"incomplete\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/retry
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="retry subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:42"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWsHFqtLrMpqCWFA0auASy\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:50"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=d51a7a48-1124-47e3-a011-86725d110e49 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:57"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1a2bWjOhaFxMx\"},\"subscription_status\":{\"status\":\"incomplete\",\"stripe_subscription_id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="executing paymentId change on the provider" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:64"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=info msg="Requesting GET api.stripe.com/v1/invoices\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=info msg="Request completed in 287.116826ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="retrieved invoice" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:119" CUSTOMER_ID=cus_L1a2bWjOhaFxMx INVOICE_ID=in_1KLWsFFqtLrMpqCWqqIOH5rW STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsFFqtLrMpqCWqqIOH5rW/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsFFqtLrMpqCWwZZr4SMB\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725759,\"start\":1643047359},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"subscription_item\":\"si_L1a2Xpy5YqX5Xi\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"A5EE159B-0001\",\"paid\":false,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsGFqtLrMpqCW0szvObEb\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047359,\"period_start\":1643047359,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643047359,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWsHFqtLrMpqCWFA0auASy/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.requires_action
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:42Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=info msg="Request completed in 839.334385ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:136" CUSTOMER_ID=cus_L1a2bWjOhaFxMx INVOICE_ID=in_1KLWsFFqtLrMpqCWqqIOH5rW STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047362,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWsHFqtLrMpqCWFA0auASy\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a2bWjOhaFxMx\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:43Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=info msg="Request completed in 475.478016ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:155" CUSTOMER_ID=cus_L1a2bWjOhaFxMx INVOICE_ID=in_1KLWsFFqtLrMpqCWqqIOH5rW STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047357,\"currency\":\"eur\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_179a2ff8-ee40-416d-9009-48348ff008c3\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"A5EE159B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsHFqtLrMpqCWFA0auASy\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":2,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/subscriptions\",\"data\":[{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047359,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"current_period_end\":1645725759,\"current_period_start\":1643047359,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047360,\"deleted\":false,\"id\":\"si_L1a2Xpy5YqX5Xi\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047359,\"status\":\"incomplete\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2bWjOhaFxMx/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=info msg="Requesting GET api.stripe.com/v1/invoices/in_1KLWsFFqtLrMpqCWqqIOH5rW\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=info msg="Request completed in 374.312788ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=debug msg="invoice id updated" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:172" CUSTOMER_ID=cus_L1a2bWjOhaFxMx INVOICE_ID=in_1KLWsFFqtLrMpqCWqqIOH5rW STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":0,\"amount_remaining\":399,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":true,\"auto_advance\":true,\"billing_reason\":\"subscription_create\",\"charge\":null,\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsFFqtLrMpqCWqqIOH5rW/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsFFqtLrMpqCWwZZr4SMB\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725759,\"start\":1643047359},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"subscription_item\":\"si_L1a2Xpy5YqX5Xi\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"A5EE159B-0001\",\"paid\":false,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges?payment_intent=pi_3KLWsGFqtLrMpqCW0szvObEb\",\"data\":[]},\"client_secret\":\"pi_3KLWsGFqtLrMpqCW0szvObEb_secret_KIk7N76L4vffW4aItOUwYzvTC\",\"confirmation_method\":\"automatic\",\"created\":1643047360,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsGFqtLrMpqCW0szvObEb\",\"metadata\":{},\"next_action\":{\"redirect_to_url\":null,\"type\":\"use_stripe_sdk\"},\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsDFqtLrMpqCWwgbYRcg9\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"requires_action\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047359,\"period_start\":1643047359,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"open\",\"status_transitions\":{\"finalized_at\":1643047359,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643047362,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:44Z" level=info msg="Requesting POST api.stripe.com/v1/invoices/in_1KLWsFFqtLrMpqCWqqIOH5rW/pay\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:46Z" level=info msg="Request completed in 2.474418325s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:46Z" level=debug msg="invoice paid" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:187" CUSTOMER_ID=cus_L1a2bWjOhaFxMx INVOICE_ID=in_1KLWsFFqtLrMpqCWqqIOH5rW STRIPE_RESPONSE="{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWsGFqtLrMpqCW07R55uAO\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyZmpWZWlkblhPZFhObTJ4eDZzN0ZsRGwzMmF10100UWAuPFLX/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsFFqtLrMpqCWqqIOH5rW/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsFFqtLrMpqCWwZZr4SMB\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725759,\"start\":1643047359},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"subscription_item\":\"si_L1a2Xpy5YqX5Xi\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"A5EE159B-0001\",\"paid\":true,\"payment_intent\":{\"amount\":0,\"amount_capturable\":0,\"amount_received\":0,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"\",\"charges\":null,\"client_secret\":\"\",\"confirmation_method\":\"\",\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"invoice\":null,\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsGFqtLrMpqCW0szvObEb\",\"metadata\":null,\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":null,\"payment_method_options\":null,\"payment_method_types\":null,\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047359,\"period_start\":1643047359,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643047359,\"marked_uncollectible_at\":0,\"paid_at\":1643047364,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":1643047362,\"tax_percent\":0}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:46Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWsFFqtLrMpqCW2TcpWHPG\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=info msg="Request completed in 254.799932ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="subscription found" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).retrySubscriptionOnStripe" file="/app/pkg/subscription/handle_retry.go:200" CUSTOMER_ID=cus_L1a2bWjOhaFxMx INVOICE_ID=in_1KLWsFFqtLrMpqCWqqIOH5rW STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047359,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047359,\"current_period_end\":1645725759,\"current_period_start\":1643047359,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2bWjOhaFxMx\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047360,\"deleted\":false,\"id\":\"si_L1a2Xpy5YqX5Xi\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsFFqtLrMpqCW2TcpWHPG\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsFFqtLrMpqCWqqIOH5rW\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047359,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsFFqtLrMpqCW2TcpWHPG
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="update subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:74"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"d51a7a48-1124-47e3-a011-86725d110e49\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=info msg="subscription retry done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*RetryHandler).ServeHTTP" file="/app/pkg/subscription/handle_retry.go:98" ACCOUNT_ID=d51a7a48-1124-47e3-a011-86725d110e49 CUSTOMER_ID=cus_L1a2bWjOhaFxMx PLAN_ID=price_1IMKMvFqtLrMpqCW3mMM3mDS SUBSCRIPTION_ID=sub_1KLWsFFqtLrMpqCW2TcpWHPG
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4735640802
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_ea858dfe-76df-44f8-b582-d852236237b5\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoice.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=info msg="Request completed in 412.942166ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_ea858dfe-76df-44f8-b582-d852236237b5 CUSTOMER_ID=cus_L1a26DAJ4A7Tqn STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047367,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_ea858dfe-76df-44f8-b582-d852236237b5\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"67C2CC31\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a26DAJ4A7Tqn/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a26DAJ4A7Tqn/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a26DAJ4A7Tqn/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=440934519
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:47Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWsNFqtLrMpqCWmWDb6ynP\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=bc538adf-cc81-48de-b6e7-f01ed4825f3c role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:48Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWsNFqtLrMpqCWmWDb6ynP/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=info msg="Request completed in 789.935218ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1a26DAJ4A7Tqn STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047368,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWsNFqtLrMpqCWmWDb6ynP\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a26DAJ4A7Tqn\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=info msg="Request completed in 402.228713ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1a26DAJ4A7Tqn STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047367,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_ea858dfe-76df-44f8-b582-d852236237b5\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"67C2CC31\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsNFqtLrMpqCWmWDb6ynP\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a26DAJ4A7Tqn/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a26DAJ4A7Tqn/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a26DAJ4A7Tqn/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:49Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=info msg="Request completed in 3.024133132s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1a26DAJ4A7Tqn STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047369,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047369,\"current_period_end\":1645725769,\"current_period_start\":1643047369,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsPFqtLrMpqCWibMg47go\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsPFqtLrMpqCWibMg47go\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047370,\"deleted\":false,\"id\":\"si_L1a2WgkMmg1SIc\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsPFqtLrMpqCWibMg47go\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWsQFqtLrMpqCW0YcXWMhY\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643047369,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyUThsMWhBYWhKMnVYOFEyaVp4Q0k3dm5jMFhw0100n9W2lewb\",\"id\":\"in_1KLWsPFqtLrMpqCW6Bc86mNT\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyUThsMWhBYWhKMnVYOFEyaVp4Q0k3dm5jMFhw0100n9W2lewb/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsPFqtLrMpqCW6Bc86mNT/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsPFqtLrMpqCWCkaELd1V\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725769,\"start\":1643047369},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsPFqtLrMpqCWibMg47go\",\"subscription_item\":\"si_L1a2WgkMmg1SIc\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"67C2CC31-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWsQFqtLrMpqCW0HoTPdMn\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWsQFqtLrMpqCW0wQcVcyM\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643047371,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWsQFqtLrMpqCW0YcXWMhY\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsPFqtLrMpqCW6Bc86mNT\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":24,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWsQFqtLrMpqCW0HoTPdMn\",\"payment_method\":\"pm_1KLWsNFqtLrMpqCWmWDb6ynP\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWsQFqtLrMpqCW0YcXWMhY/rcpt_L1a2r2TOsTBZz7NcZlgAAKSQgaq5hVM\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWsQFqtLrMpqCW0YcXWMhY/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWsQFqtLrMpqCW0HoTPdMn_secret_TNURkV733nv94N2IblolmS3Mx\",\"confirmation_method\":\"automatic\",\"created\":1643047370,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a26DAJ4A7Tqn\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsPFqtLrMpqCW6Bc86mNT\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsQFqtLrMpqCW0HoTPdMn\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsNFqtLrMpqCWmWDb6ynP\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047369,\"period_start\":1643047369,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643047369,\"marked_uncollectible_at\":0,\"paid_at\":1643047369,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsPFqtLrMpqCWibMg47go\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047369,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsPFqtLrMpqCWibMg47go
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4245435570
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/change
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="change subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:52"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"id_plan\":\"premium\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="get stripe plan id" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func2" file="/app/pkg/subscription/handle_change.go:94"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:66"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=bc538adf-cc81-48de-b6e7-f01ed4825f3c role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP.func1" file="/app/pkg/subscription/handle_change.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="GetStripePlanFromPlanID result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripePlanFromPlan file="/app/pkg/subscription/handle_utils.go:31" HASURA_RESPONSE="{\"subscription_plan\":[{\"stripe_code\":\"price_1IMKNbFqtLrMpqCWztWScMzg\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="QuerySubscription result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getStripeCustomerIdFromHasura file="/app/pkg/subscription/handle_utils.go:50" result="{\"saas_account\":[{\"id\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"subscription_customer\":{\"stripe_customer\":\"cus_L1a26DAJ4A7Tqn\"},\"subscription_status\":{\"status\":\"active\",\"stripe_subscription_id\":\"sub_1KLWsPFqtLrMpqCWibMg47go\",\"subscription_plan\":{\"stripe_code\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"trial_days\":null}}}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="update subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:115"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="getting subscription information from stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:155"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=info msg="Requesting GET api.stripe.com/v1/subscriptions/sub_1KLWsPFqtLrMpqCWibMg47go\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=info msg="Request completed in 270.112074ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="updating subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).updateStripeSubscription" file="/app/pkg/subscription/handle_change.go:162"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions/sub_1KLWsPFqtLrMpqCWibMg47go\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:52Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=info msg="Request completed in 1.031985101s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:122"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"premium\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"id_plan\":\"premium\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:129"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"bc538adf-cc81-48de-b6e7-f01ed4825f3c\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=info msg="subscription change done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*ChangeHandler).ServeHTTP" file="/app/pkg/subscription/handle_change.go:146" ACCOUNT_ID=bc538adf-cc81-48de-b6e7-f01ed4825f3c CUSTOMER_ID=cus_L1a26DAJ4A7Tqn PLAN_ID=price_1IMKNbFqtLrMpqCWztWScMzg SUBSCRIPTION_ID=sub_1KLWsPFqtLrMpqCWibMg47go
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1329602971
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_9b8df1ec-287d-43ca-af80-5ff17ff14abd\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:53Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=customer.subscription.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=warning msg="event not mapped" func=github.com/ddelizia/hasura-saas/pkg/subscription.EventMapping file="/app/pkg/subscription/event_mapping.go:50" eventType=invoiceitem.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=info msg="Request completed in 390.861288ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_9b8df1ec-287d-43ca-af80-5ff17ff14abd CUSTOMER_ID=cus_L1a29SzJwfZc7p STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047373,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_9b8df1ec-287d-43ca-af80-5ff17ff14abd\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"0AA4166B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a29SzJwfZc7p/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a29SzJwfZc7p/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a29SzJwfZc7p/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"e86e38a3-8c87-4020-9a6e-8a2809f9ced0\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=417243504
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"e86e38a3-8c87-4020-9a6e-8a2809f9ced0\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWsUFqtLrMpqCW1sd48h2x\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=e86e38a3-8c87-4020-9a6e-8a2809f9ced0 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:54Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWsUFqtLrMpqCW1sd48h2x/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=info msg="Request completed in 763.334334ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1a29SzJwfZc7p STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047374,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWsUFqtLrMpqCW1sd48h2x\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a29SzJwfZc7p\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:55Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=info msg="Request completed in 415.695198ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1a29SzJwfZc7p STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047373,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_9b8df1ec-287d-43ca-af80-5ff17ff14abd\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"0AA4166B\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsUFqtLrMpqCW1sd48h2x\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a29SzJwfZc7p/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a29SzJwfZc7p/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a29SzJwfZc7p/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:56Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=info msg="Request completed in 3.063473729s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1a29SzJwfZc7p STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047376,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047376,\"current_period_end\":1645725776,\"current_period_start\":1643047376,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047376,\"deleted\":false,\"id\":\"si_L1a2VcKQ8LxxpK\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWsXFqtLrMpqCW0QSclsAi\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643047376,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyMkRvbXJxenhpQjNRZnFUVDhpUjJOcEttOEhH0100Q0RZpYm3\",\"id\":\"in_1KLWsWFqtLrMpqCWE1CUYKxj\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyMkRvbXJxenhpQjNRZnFUVDhpUjJOcEttOEhH0100Q0RZpYm3/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsWFqtLrMpqCWE1CUYKxj/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsWFqtLrMpqCW262onJ6N\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725776,\"start\":1643047376},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"subscription_item\":\"si_L1a2VcKQ8LxxpK\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"0AA4166B-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWsXFqtLrMpqCW0RtJVgWP\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWsXFqtLrMpqCW09KSoZ27\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643047377,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWsXFqtLrMpqCW0QSclsAi\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsWFqtLrMpqCWE1CUYKxj\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":50,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWsXFqtLrMpqCW0RtJVgWP\",\"payment_method\":\"pm_1KLWsUFqtLrMpqCW1sd48h2x\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWsXFqtLrMpqCW0QSclsAi/rcpt_L1a2gOcAFxxK8VEzexRjBLXhRt4o79j\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWsXFqtLrMpqCW0QSclsAi/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWsXFqtLrMpqCW0RtJVgWP_secret_RT3gXdNYBRNW5V7PPsv7Y8F3C\",\"confirmation_method\":\"automatic\",\"created\":1643047377,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsWFqtLrMpqCWE1CUYKxj\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWsXFqtLrMpqCW0RtJVgWP\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsUFqtLrMpqCW1sd48h2x\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047376,\"period_start\":1643047376,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643047376,\"marked_uncollectible_at\":0,\"paid_at\":1643047376,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047376,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsWFqtLrMpqCW5iYQph0V
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"e86e38a3-8c87-4020-9a6e-8a2809f9ced0\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"e86e38a3-8c87-4020-9a6e-8a2809f9ced0\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4277392690
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/cancel
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="cancel subscription request" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:36"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"e86e38a3-8c87-4020-9a6e-8a2809f9ced0\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="getting authorization information" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:44"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=e86e38a3-8c87-4020-9a6e-8a2809f9ced0 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="retrieving subscription id on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:51"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="GetStripeSubscription result" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).getStripeSubscriptionID" file="/app/pkg/subscription/handle_cancel.go:99" HASURA_RESPONSE="{\"subscription_status\":[{\"stripe_subscription_id\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="cancelling stripe subscription" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:58"
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=info msg="Requesting DELETE api.stripe.com/v1/subscriptions/sub_1KLWsWFqtLrMpqCW5iYQph0V\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:02:59Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:00Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=info msg="Request completed in 1.787980005s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).cancelStripeSubscription" file="/app/pkg/subscription/handle_cancel.go:120" ACCOUNT_ID=e86e38a3-8c87-4020-9a6e-8a2809f9ced0 STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047376,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":1643047380,\"collection_method\":\"charge_automatically\",\"created\":1643047376,\"current_period_end\":1645725776,\"current_period_start\":1643047376,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a29SzJwfZc7p\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":1643047380,\"id\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047376,\"deleted\":false,\"id\":\"si_L1a2VcKQ8LxxpK\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsWFqtLrMpqCW5iYQph0V\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsWFqtLrMpqCWE1CUYKxj\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047376,\"status\":\"canceled\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsWFqtLrMpqCW5iYQph0V
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="updating hasura with the cancellation status" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:65"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription.getPlanFromStripePlan file="/app/pkg/subscription/handle_utils.go:72" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription.updateHasuraSubscription file="/app/pkg/subscription/handle_utils.go:96" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"e86e38a3-8c87-4020-9a6e-8a2809f9ced0\",\"id_plan\":\"basic\",\"is_active\":false,\"status\":\"canceled\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="building response" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*CancelHandler).ServeHTTP" file="/app/pkg/subscription/handle_cancel.go:72"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"status\":\"canceled\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=1810558149
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_f9107247-b3cd-4dc5-a594-1694cc5ef387\",\"id_plan\":\"basic\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.deleted
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.deleted
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=info msg="Request completed in 395.349544ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_f9107247-b3cd-4dc5-a594-1694cc5ef387 CUSTOMER_ID=cus_L1a27qGwCY4GsS STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047381,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_f9107247-b3cd-4dc5-a594-1694cc5ef387\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"1D840393\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a27qGwCY4GsS/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a27qGwCY4GsS/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a27qGwCY4GsS/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ae14914d-21dd-4db1-a0be-53991c846f12\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=420417819
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:01Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ae14914d-21dd-4db1-a0be-53991c846f12\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"payment_method_id\":\"pm_1KLWsbFqtLrMpqCWpybM1fLU\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ae14914d-21dd-4db1-a0be-53991c846f12 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="getting saas account information from hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:75"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="create subscription on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:81"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=info msg="Requesting POST api.stripe.com/v1/payment_methods/pm_1KLWsbFqtLrMpqCWpybM1fLU/attach\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=info msg="Request completed in 813.766123ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=debug msg="payment attached" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:157" CUSTOMER_ID=cus_L1a27qGwCY4GsS STRIPE_RESPONSE="{\"au_becs_debit\":null,\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"last4\":\"4242\",\"three_d_secure_usage\":{\"supported\":true},\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"created\":1643047382,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"fpx\":null,\"id\":\"pm_1KLWsbFqtLrMpqCWpybM1fLU\",\"ideal\":null,\"livemode\":false,\"metadata\":{},\"object\":\"payment_method\",\"sepa_debit\":null,\"type\":\"card\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:02Z" level=info msg="Requesting POST api.stripe.com/v1/customers/cus_L1a27qGwCY4GsS\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_method.attached
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=info msg="Request completed in 421.686989ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=debug msg="default payment method for customer updated" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:176" CUSTOMER_ID=cus_L1a27qGwCY4GsS STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047381,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_f9107247-b3cd-4dc5-a594-1694cc5ef387\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"1D840393\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsbFqtLrMpqCWpybM1fLU\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a27qGwCY4GsS/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a27qGwCY4GsS/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a27qGwCY4GsS/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:03Z" level=info msg="Requesting POST api.stripe.com/v1/subscriptions\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=info msg="Request completed in 3.4296177s (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="subscription done" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).attachPaymentMethodToStripeCustomer" file="/app/pkg/subscription/hsstripe/svc_create.go:206" CUSTOMER_ID=cus_L1a27qGwCY4GsS STRIPE_RESPONSE="{\"application_fee_percent\":0,\"billing_cycle_anchor\":1643047383,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"charge_automatically\",\"created\":1643047383,\"current_period_end\":1645725783,\"current_period_start\":1643047383,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsdFqtLrMpqCWdv8favJ3\",\"items\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/subscription_items?subscription=sub_1KLWsdFqtLrMpqCWdv8favJ3\",\"data\":[{\"billing_thresholds\":{\"UsageGTE\":0},\"created\":1643047384,\"deleted\":false,\"id\":\"si_L1a2vAU1EpWopf\",\"metadata\":{},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"subscription\":\"sub_1KLWsdFqtLrMpqCWdv8favJ3\",\"tax_rates\":[]}]},\"latest_invoice\":{\"account_country\":\"ES\",\"account_name\":\"Cartisy\",\"amount_due\":399,\"amount_paid\":399,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":1,\"attempted\":true,\"auto_advance\":false,\"billing_reason\":\"subscription_create\",\"charge\":{\"amount\":0,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":null,\"billing_details\":null,\"calculated_statement_descriptor\":\"\",\"captured\":false,\"created\":0,\"currency\":\"\",\"customer\":null,\"description\":\"\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":null,\"id\":\"ch_3KLWseFqtLrMpqCW1SA6zfQB\",\"invoice\":null,\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":null,\"on_behalf_of\":null,\"outcome\":null,\"paid\":false,\"payment_intent\":\"\",\"payment_method\":\"\",\"payment_method_details\":null,\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"\",\"refunded\":false,\"refunds\":null,\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"},\"collection_method\":\"charge_automatically\",\"created\":1643047383,\"currency\":\"eur\",\"custom_fields\":null,\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"none\",\"customer_tax_ids\":[],\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":[],\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"https://invoice.stripe.com/i/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyUEtvQU1xa1BmZGxDdDlodlltVHllRlR5YThJ0100FatlBMls\",\"id\":\"in_1KLWsdFqtLrMpqCWN6MyEr5b\",\"invoice_pdf\":\"https://pay.stripe.com/invoice/acct_16EJx5FqtLrMpqCW/test_YWNjdF8xNkVKeDVGcXRMck1wcUNXLF9MMWEyUEtvQU1xa1BmZGxDdDlodlltVHllRlR5YThJ0100FatlBMls/pdf\",\"lines\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/invoices/in_1KLWsdFqtLrMpqCWN6MyEr5b/lines\",\"data\":[{\"amount\":399,\"currency\":\"eur\",\"description\":\"1 ? Basic (at ?3.99 / month)\",\"discountable\":true,\"id\":\"il_1KLWsdFqtLrMpqCWbZROuanQ\",\"invoice_item\":\"\",\"livemode\":false,\"metadata\":{},\"period\":{\"end\":1645725783,\"start\":1643047383},\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"proration\":false,\"quantity\":1,\"subscription\":\"sub_1KLWsdFqtLrMpqCWdv8favJ3\",\"subscription_item\":\"si_L1a2vAU1EpWopf\",\"tax_amounts\":[],\"tax_rates\":[],\"type\":\"subscription\",\"unified_proration\":false}]},\"livemode\":false,\"metadata\":{},\"next_payment_attempt\":0,\"number\":\"1D840393-0001\",\"paid\":true,\"payment_intent\":{\"amount\":399,\"amount_capturable\":0,\"amount_received\":399,\"application\":null,\"application_fee_amount\":0,\"canceled_at\":0,\"cancellation_reason\":\"\",\"capture_method\":\"automatic\",\"charges\":{\"has_more\":false,\"total_count\":1,\"url\":\"/v1/charges?payment_intent=pi_3KLWseFqtLrMpqCW1tRnPHur\",\"data\":[{\"amount\":399,\"amount_refunded\":0,\"application\":null,\"application_fee\":null,\"application_fee_amount\":0,\"authorization_code\":\"\",\"balance_transaction\":{\"amount\":0,\"available_on\":0,\"created\":0,\"currency\":\"\",\"description\":\"\",\"exchange_rate\":0,\"id\":\"txn_3KLWseFqtLrMpqCW1qub4Jh7\",\"fee\":0,\"fee_details\":null,\"net\":0,\"recipient\":\"\",\"reporting_category\":\"\",\"source\":null,\"status\":\"\",\"type\":\"\"},\"billing_details\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"email\":\"\",\"name\":\"\",\"phone\":\"\"},\"calculated_statement_descriptor\":\"DANILO DELIZIA\",\"captured\":true,\"created\":1643047385,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"destination\":null,\"dispute\":null,\"disputed\":false,\"failure_code\":\"\",\"failure_message\":\"\",\"fraud_details\":{\"user_report\":\"\",\"stripe_report\":\"\"},\"id\":\"ch_3KLWseFqtLrMpqCW1SA6zfQB\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsdFqtLrMpqCWN6MyEr5b\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"level3\":{\"customer_reference\":\"\",\"line_items\":null,\"merchant_reference\":\"\",\"shipping_address_zip\":\"\",\"shipping_from_zip\":\"\",\"shipping_amount\":0},\"livemode\":false,\"metadata\":{},\"on_behalf_of\":null,\"outcome\":{\"network_status\":\"approved_by_network\",\"reason\":\"\",\"risk_level\":\"normal\",\"risk_score\":49,\"rule\":null,\"seller_message\":\"Payment complete.\",\"type\":\"authorized\"},\"paid\":true,\"payment_intent\":\"pi_3KLWseFqtLrMpqCW1tRnPHur\",\"payment_method\":\"pm_1KLWsbFqtLrMpqCWpybM1fLU\",\"payment_method_details\":{\"ach_credit_transfer\":null,\"ach_debit\":null,\"alipay\":null,\"bancontact\":null,\"au_becs_debit\":null,\"bitcoin\":null,\"card\":{\"brand\":\"visa\",\"checks\":{\"address_line1_check\":\"\",\"address_postal_code_check\":\"\",\"cvc_check\":\"pass\"},\"country\":\"US\",\"exp_month\":1,\"exp_year\":2030,\"fingerprint\":\"C6Iyal6atn76qH8y\",\"funding\":\"credit\",\"installments\":null,\"last4\":\"4242\",\"network\":\"visa\",\"moto\":false,\"three_d_secure\":null,\"wallet\":null,\"description\":\"\",\"iin\":\"\",\"issuer\":\"\"},\"card_present\":null,\"eps\":null,\"fpx\":null,\"giropay\":null,\"ideal\":null,\"klarna\":null,\"multibanco\":null,\"p24\":null,\"sepa_debit\":null,\"sofort\":null,\"stripe_account\":null,\"type\":\"card\",\"wechat\":null},\"receipt_email\":\"\",\"receipt_number\":\"\",\"receipt_url\":\"https://pay.stripe.com/receipts/acct_16EJx5FqtLrMpqCW/ch_3KLWseFqtLrMpqCW1SA6zfQB/rcpt_L1a2Txar5ETIH9TYG96kvJwe6fMsxed\",\"refunded\":false,\"refunds\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/charges/ch_3KLWseFqtLrMpqCW1SA6zfQB/refunds\",\"data\":[]},\"review\":null,\"shipping\":null,\"source\":null,\"source_transfer\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer\":null,\"transfer_data\":null,\"transfer_group\":\"\"}]},\"client_secret\":\"pi_3KLWseFqtLrMpqCW1tRnPHur_secret_U1k3arvaZw1YSUKrcputag8Zv\",\"confirmation_method\":\"automatic\",\"created\":1643047384,\"currency\":\"eur\",\"customer\":{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":0,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a27qGwCY4GsS\",\"invoice_prefix\":\"\",\"invoice_settings\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"next_invoice_sequence\":0,\"phone\":\"\",\"preferred_locales\":null,\"shipping\":null,\"sources\":null,\"subscriptions\":null,\"tax_exempt\":\"\",\"tax_ids\":null},\"description\":\"Subscription creation\",\"invoice\":{\"account_country\":\"\",\"account_name\":\"\",\"amount_due\":0,\"amount_paid\":0,\"amount_remaining\":0,\"application_fee_amount\":0,\"attempt_count\":0,\"attempted\":false,\"auto_advance\":false,\"billing_reason\":\"\",\"charge\":null,\"collection_method\":null,\"created\":0,\"currency\":\"\",\"custom_fields\":null,\"customer\":null,\"customer_address\":null,\"customer_email\":\"\",\"customer_name\":null,\"customer_phone\":null,\"customer_shipping\":null,\"customer_tax_exempt\":\"\",\"customer_tax_ids\":null,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"description\":\"\",\"discount\":null,\"due_date\":0,\"ending_balance\":0,\"footer\":\"\",\"hosted_invoice_url\":\"\",\"id\":\"in_1KLWsdFqtLrMpqCWN6MyEr5b\",\"invoice_pdf\":\"\",\"lines\":null,\"livemode\":false,\"metadata\":null,\"next_payment_attempt\":0,\"number\":\"\",\"paid\":false,\"payment_intent\":null,\"period_end\":0,\"period_start\":0,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"\",\"status_transitions\":{\"finalized_at\":0,\"marked_uncollectible_at\":0,\"paid_at\":0,\"voided_at\":0},\"subscription\":null,\"subscription_proration_date\":0,\"subtotal\":0,\"tax\":0,\"threshold_reason\":null,\"total\":0,\"total_tax_amounts\":null,\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"last_payment_error\":null,\"livemode\":false,\"id\":\"pi_3KLWseFqtLrMpqCW1tRnPHur\",\"metadata\":{},\"next_action\":null,\"on_behalf_of\":null,\"payment_method\":{\"au_becs_debit\":null,\"billing_details\":null,\"card\":null,\"card_present\":null,\"created\":0,\"customer\":null,\"fpx\":null,\"id\":\"pm_1KLWsbFqtLrMpqCWpybM1fLU\",\"ideal\":null,\"livemode\":false,\"metadata\":null,\"object\":\"\",\"sepa_debit\":null,\"type\":\"\"},\"payment_method_options\":{\"card\":{\"installments\":null,\"request_three_d_secure\":\"automatic\"}},\"payment_method_types\":[\"card\",\"sepa_debit\"],\"receipt_email\":\"\",\"review\":null,\"setup_future_usage\":\"off_session\",\"shipping\":{\"address\":null,\"carrier\":\"\",\"name\":\"\",\"phone\":\"\",\"tracking_number\":\"\"},\"source\":null,\"statement_descriptor\":\"\",\"statement_descriptor_suffix\":\"\",\"status\":\"succeeded\",\"transfer_data\":null,\"transfer_group\":\"\"},\"period_end\":1643047383,\"period_start\":1643047383,\"post_payment_credit_notes_amount\":0,\"pre_payment_credit_notes_amount\":0,\"receipt_number\":\"\",\"starting_balance\":0,\"statement_descriptor\":\"\",\"status\":\"paid\",\"status_transitions\":{\"finalized_at\":1643047383,\"marked_uncollectible_at\":0,\"paid_at\":1643047383,\"voided_at\":0},\"subscription\":{\"application_fee_percent\":0,\"billing_cycle_anchor\":0,\"billing_thresholds\":null,\"cancel_at\":0,\"cancel_at_period_end\":false,\"canceled_at\":0,\"collection_method\":\"\",\"created\":0,\"current_period_end\":0,\"current_period_start\":0,\"customer\":null,\"days_until_due\":0,\"default_payment_method\":null,\"default_source\":null,\"default_tax_rates\":null,\"discount\":null,\"ended_at\":0,\"id\":\"sub_1KLWsdFqtLrMpqCWdv8favJ3\",\"items\":null,\"latest_invoice\":null,\"livemode\":false,\"metadata\":null,\"next_pending_invoice_item_invoice\":0,\"object\":\"\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":null,\"quantity\":0,\"schedule\":null,\"start_date\":0,\"status\":\"\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0},\"subscription_proration_date\":0,\"subtotal\":399,\"tax\":0,\"threshold_reason\":null,\"total\":399,\"total_tax_amounts\":[],\"transfer_data\":null,\"webhooks_delivered_at\":0,\"tax_percent\":0},\"livemode\":false,\"metadata\":{},\"next_pending_invoice_item_invoice\":0,\"object\":\"subscription\",\"on_behalf_of\":null,\"pause_collection\":{\"behavior\":\"\",\"resumes_at\":0},\"pending_invoice_item_interval\":{\"interval\":\"\",\"interval_count\":0},\"pending_setup_intent\":null,\"pending_update\":null,\"plan\":{\"active\":true,\"aggregate_usage\":\"\",\"amount\":399,\"amount_decimal\":\"399\",\"billing_scheme\":\"per_unit\",\"created\":1613684945,\"currency\":\"eur\",\"deleted\":false,\"id\":\"price_1IMKMvFqtLrMpqCW3mMM3mDS\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":false,\"metadata\":{},\"nickname\":\"\",\"product\":{\"active\":false,\"attributes\":null,\"caption\":\"\",\"created\":0,\"deactivate_on\":null,\"description\":\"\",\"id\":\"prod_IyGuXgX5igQgme\",\"images\":null,\"livemode\":false,\"metadata\":null,\"name\":\"\",\"package_dimensions\":null,\"shippable\":false,\"statement_descriptor\":\"\",\"type\":\"\",\"unit_label\":\"\",\"url\":\"\",\"updated\":0},\"tiers\":null,\"tiers_mode\":\"\",\"transform_usage\":null,\"trial_period_days\":0,\"usage_type\":\"licensed\"},\"quantity\":1,\"schedule\":null,\"start_date\":1643047383,\"status\":\"active\",\"transfer_data\":null,\"trial_end\":0,\"trial_start\":0,\"tax_percent\":0}" SUBSCRIPTION_ID=sub_1KLWsdFqtLrMpqCWdv8favJ3
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="create subscription on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:93"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="GetPlanFromStripePlan result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.getPlanFromStripePlan file="/app/pkg/subscription/hsstripe/utils_get_plan_from_stripe_plan.go:30" HASURA_RESPONSE="{\"subscription_plan\":[{\"id\":\"basic\"}]}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="SetSubscriptioStatus result" func=github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.updateHasuraSubscription file="/app/pkg/subscription/hsstripe/utils_update_hasura_subscription.go:32" result="{\"update_subscription_status\":{\"affected_rows\":1,\"returning\":[{\"id_account\":\"ae14914d-21dd-4db1-a0be-53991c846f12\",\"id_plan\":\"basic\",\"is_active\":true,\"status\":\"active\"}]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="building create response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeCreate).Create" file="/app/pkg/subscription/hsstripe/svc_create.go:99"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ae14914d-21dd-4db1-a0be-53991c846f12\",\"is_active\":true}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=4696233027
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/init
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"no-account\",\"x-hasura-role\":\"logged_in\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{\"account_name\":\"subscription_test_account_f090fb4d-1a3d-459f-90e8-fd6c44b84e88\",\"id_plan\":\"free\"}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=no-account role=logged_in userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="make sure plan exists on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:71"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=debug msg="creating customer on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:77"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:06Z" level=info msg="Requesting POST api.stripe.com/v1/customers\n" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=charge.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=info msg="Request completed in 382.313303ms (retry: 0)" component=stripe
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=info msg="customer created on stripe" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).createCustomerOnStripe" file="/app/pkg/subscription/hsstripe/svc_init.go:132" ACCOUNT_NAME=subscription_test_account_f090fb4d-1a3d-459f-90e8-fd6c44b84e88 CUSTOMER_ID=cus_L1a2IhNhKHDHRr STRIPE_RESPONSE="{\"address\":{\"city\":\"\",\"country\":\"\",\"line1\":\"\",\"line2\":\"\",\"postal_code\":\"\",\"state\":\"\"},\"balance\":0,\"created\":1643047387,\"currency\":\"\",\"default_source\":null,\"deleted\":false,\"delinquent\":false,\"description\":\"Stripe customer for account subscription_test_account_f090fb4d-1a3d-459f-90e8-fd6c44b84e88\",\"discount\":null,\"email\":\"\",\"id\":\"cus_L1a2IhNhKHDHRr\",\"invoice_prefix\":\"EE2EF6F6\",\"invoice_settings\":{\"custom_fields\":null,\"default_payment_method\":null,\"footer\":\"\"},\"livemode\":false,\"metadata\":{},\"name\":\"\",\"next_invoice_sequence\":1,\"phone\":\"\",\"preferred_locales\":[],\"shipping\":null,\"sources\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2IhNhKHDHRr/sources\",\"data\":[]},\"subscriptions\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2IhNhKHDHRr/subscriptions\",\"data\":[]},\"tax_exempt\":\"none\",\"tax_ids\":{\"has_more\":false,\"total_count\":0,\"url\":\"/v1/customers/cus_L1a2IhNhKHDHRr/tax_ids\",\"data\":[]}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="updating user information on hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:83"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="building init response" func="github.com/ddelizia/hasura-saas/pkg/subscription/hsstripe.(*StripeInit).Init" file="/app/pkg/subscription/hsstripe/svc_init.go:89"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="sending body" func=github.com/ddelizia/hasura-saas/pkg/hshttp.WriteBody file="/app/pkg/hshttp/request.go:37" body="{\"id_account\":\"ad712767-3230-4b76-a344-cbc1d7950cf9\"}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="response time" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:27" responseTimeNS=399800818
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:38912" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ad712767-3230-4b76-a344-cbc1d7950cf9\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ad712767-3230-4b76-a344-cbc1d7950cf9 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 18:03:07 http: panic serving 172.26.0.3:38912: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 652 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc0000de000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0003028c0, 0xc0002ec700)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0003028c0, 0xc0002ec700)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0003028c0, 0xc0002ec600)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0003028c0, 0xc0002ec500)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0003028c0, 0xc0002ec400)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0003028c0, 0xc0002ec400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0003028c0, 0xc0002ec200)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0003028c0, 0xc0002ec200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0003028c0, 0xc0002ec200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc0000de000, 0x908440, 0xc000212000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:39190" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ad712767-3230-4b76-a344-cbc1d7950cf9\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ad712767-3230-4b76-a344-cbc1d7950cf9 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 18:03:07 http: panic serving 172.26.0.3:39190: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 777 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00045d400)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc00044e620, 0xc000348100)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc00044e620, 0xc000348100)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc00044e620, 0xc000348000)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc00044e620, 0xc0002b3f00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc00044e620, 0xc0002b3e00)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc00044e620, 0xc0002b3e00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc00044e620, 0xc0002b3c00)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc00044e620, 0xc0002b3c00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc00044e620, 0xc0002b3c00)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00045d400, 0x908440, 0xc000097200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.finalized
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.paid
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=invoice.payment_succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:07Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.subscription.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:08Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.created
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:16Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:16Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:16Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=payment_intent.succeeded
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:24Z" level=debug msg="storing event into hasura" func="github.com/ddelizia/hasura-saas/pkg/subscription.(*WebhookHandler).ServeHTTP" file="/app/pkg/subscription/handle_webhook.go:46" event=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Admin-Secret=mysecrethasura
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:24Z" level=debug msg="setting request header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHaderOnRequest file="/app/pkg/hshttp/headers.go:13" X-Hasura-Role=admin
[36mhs-subscription_1  |[0m time="2022-01-24T18:03:24Z" level=debug msg="processing event" func=github.com/ddelizia/hasura-saas/pkg/subscription.beforeEvent file="/app/pkg/subscription/event_util.go:15" eventType=customer.updated
[36mhs-subscription_1  |[0m time="2022-01-24T18:07:53Z" level=debug msg="processing request" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1 file="/app/pkg/hshttp/hsmiddleware/log_request.go:23" method=POST remote="172.26.0.3:41076" url=/create
[36mhs-subscription_1  |[0m time="2022-01-24T18:07:53Z" level=debug msg="parsing the body" func=github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1 file="/app/pkg/hshttp/hsmiddleware/action_body_context.go:17"
[36mhs-subscription_1  |[0m time="2022-01-24T18:07:53Z" level=debug msg="received request payload" func=github.com/ddelizia/hasura-saas/pkg/hshttp.GetBody file="/app/pkg/hshttp/request.go:25" payload="{\"session_variables\":{\"x-hasura-account-id\":\"ad712767-3230-4b76-a344-cbc1d7950cf9\",\"x-hasura-role\":\"account_owner\",\"x-hasura-user-id\":\"user1\"},\"input\":{\"data\":{}}}"
[36mhs-subscription_1  |[0m time="2022-01-24T18:07:53Z" level=debug msg="authz session set" func="github.com/ddelizia/hasura-saas/pkg/gqlreq.(*HeaderInfoGetterImpl).GetSessionInfo" file="/app/pkg/gqlreq/svc_get_session_info.go:38" accountId=ad712767-3230-4b76-a344-cbc1d7950cf9 role=account_owner userId=user1
[36mhs-subscription_1  |[0m time="2022-01-24T18:07:53Z" level=debug msg="setting response header" func=github.com/ddelizia/hasura-saas/pkg/hshttp.SetHeaderOnResponse file="/app/pkg/hshttp/headers.go:18" Content-Type=application/json
[36mhs-subscription_1  |[0m 2022/01/24 18:07:53 http: panic serving 172.26.0.3:41076: runtime error: invalid memory address or nil pointer dereference
[36mhs-subscription_1  |[0m goroutine 779 [running]:
[36mhs-subscription_1  |[0m net/http.(*conn).serve.func1(0xc00045c000)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1804 +0x153
[36mhs-subscription_1  |[0m panic(0x7f9b20, 0xaffbb0)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/runtime/panic.go:971 +0x499
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/subscription.(*CreateHandler).ServeHTTP(0xc00018e990, 0x9077e0, 0xc0001581c0, 0xc00014a900)
[36mhs-subscription_1  |[0m 	/app/pkg/subscription/handle_create.go:42 +0x156
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.Json.func1.1(0x9077e0, 0xc0001581c0, 0xc00014a900)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/json.go:13 +0x93
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.AuthzFromSession.func1.1(0x9077e0, 0xc0001581c0, 0xc00014a800)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/authz_from_session.go:23 +0x21c
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.ActionBodyToContext.func1.1(0x9077e0, 0xc0001581c0, 0xc00014a700)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/action_body_context.go:34 +0x4e2
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(...)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049
[36mhs-subscription_1  |[0m github.com/ddelizia/hasura-saas/pkg/hshttp/hsmiddleware.LogRequest.func1.1(0x9077e0, 0xc0001581c0, 0xc00014a600)
[36mhs-subscription_1  |[0m 	/app/pkg/hshttp/hsmiddleware/log_request.go:24 +0x476
[36mhs-subscription_1  |[0m net/http.HandlerFunc.ServeHTTP(0xc00018e9c0, 0x9077e0, 0xc0001581c0, 0xc00014a600)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2049 +0x44
[36mhs-subscription_1  |[0m github.com/gorilla/mux.(*Router).ServeHTTP(0xc000196000, 0x9077e0, 0xc0001581c0, 0xc00014a200)
[36mhs-subscription_1  |[0m 	/go/pkg/mod/github.com/gorilla/mux@v1.8.0/mux.go:210 +0xd3
[36mhs-subscription_1  |[0m net/http.(*ServeMux).ServeHTTP(0xb11780, 0x9077e0, 0xc0001581c0, 0xc00014a200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2428 +0x1ad
[36mhs-subscription_1  |[0m net/http.serverHandler.ServeHTTP(0xc0001582a0, 0x9077e0, 0xc0001581c0, 0xc00014a200)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2867 +0xa3
[36mhs-subscription_1  |[0m net/http.(*conn).serve(0xc00045c000, 0x908440, 0xc0003f4040)
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:1932 +0x8cd
[36mhs-subscription_1  |[0m created by net/http.(*Server).Serve
[36mhs-subscription_1  |[0m 	/usr/local/go/src/net/http/server.go:2993 +0x39b
